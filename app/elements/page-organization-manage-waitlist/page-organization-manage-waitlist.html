<!-- iron-* --><!-- paper-* --><!-- style --><!-- behavior --><!-- custom-elements --><!-- element --><dom-module id="page-organization-manage-waitlist">
  <template>

    <!-- style -->

    <style is="custom-style" include="common-style">
      .limiting-container {
        margin-top: 10px;
      }

      .organization-info-card-counter {
        margin-top: 20px;
        color: #777777;
      }

      .organization-info-cards {
        @apply(--layout-vertical);
        /*@apply(--layout-center);*/
        margin-top: 10px;
      }

      .organization-info-cards .row {
        margin-left: 10px;
        /*margin-right: 10px;*/
        margin-top: 10px;
      }

      .organization-info-cards .hr {
        margin-left: 20px;
        margin-right: 20px;
        height: 1px;
        /*width: 100px;*/
        background: #dddddd;
      }

      .organization-info-cards .row .modifier {
        font-size: 14px;
        background: #000000;
        color: #ffffff;
        margin-left: 5px;
        padding-top: 2px;
        padding-bottom: 2px;
        padding-left: 4px;
        padding-right: 4px;
        border-radius: 4px;
        text-transform: uppercase;
      }

      .organization-info-cards .row .modifier.online {
        background: #757575;
      }

      .organization-info-cards .row .modifier.local-only {
        background: #039BE5;
      }

      .organization-info-cards .row .modifier.locally-updated {
        background: #009688;
      }

      .organization-info-cards .row .modifier.imported {
        background: #4CAF50;
      }

      .info-row {
        margin-top: 10px;
      }

      .top-info-row {
        margin-top: 10px;
        margin-bottom: 10px;
      }

      .serial-number {
        background: #37474F;
        color: #ffffff;
        margin-left: 5px;
        padding-top: 2px;
        padding-bottom: 2px;
        padding-left: 4px;
        padding-right: 4px;
        border-radius: 4px;
        text-transform: uppercase;
        font-weight: bold;
      }

      .address1 {
        margin-right: 10px;
      }

      .break-on-tablet {
        @apply(--layout-horizontal);
      }

      @media screen and (max-width: 740px) {
        .break-on-tablet {
          display: block;
        }
      }

      .val {
        text-decoration: underline;
      }

      .card-custom-header {
        padding: 15px;
        border-bottom: 1px solid var(--paper-grey-200);
        background-color: var(--paper-grey-50);
      }

      .card-custom-header .title {
        font-size: 20px;
        font-weight: 500;
        line-height: 28px;
        color: var(--brand-primary-color);
      }

      .list-item {
        border-bottom: 1px solid var(--paper-grey-100);
      }

      .list-item:hover {
        background-color: var(--paper-grey-50);
      }

      .waitlist-item {
        padding: 20px 40px;
      }
      .waitlist-item:nth-child(odd){
        background-color: var(--paper-grey-100);
      }
    </style>

    <!-- local DOM -->

    <div class="master-container">

      <div class="limiting-container">

        <template is="dom-if" if="[[isLoading]]">Loading...</template>

        <!-- editing organization - start -->
        <template is="dom-if" if="{{isOrganizationValid}}">

          <div class="organization-info-card-counter">
            <div>Basic Information</div>
          </div>

          <paper-card class="organization-info-cards">
            <div class="card-content">
              <div class="horizontal layout center top-info-row">
                <div>ID: </div>
                <div class="serial-number">[[organization.idOnServer]]</div>
                <div class="flex"></div>
              </div>
              <div class="info-row">
                <div>Name: [[organization.name]]</div>
              </div>
              <div class="info-row">
                <div>Region: [[organization.effectiveRegion]]</div>
              </div>
              <div class="info-row">
                <div>Address: [[organization.address]]</div>
              </div>
            </div>
          </paper-card>

          <div class="organization-info-card-counter horizontal layout center">
            <div>Waitlist Manager</div>
            <div class="flex"></div>
            <paper-button class="btn btn-success" raised="" on-tap="saveTapped">
              <iron-icon icon="save"></iron-icon>&nbsp; SAVE WAITLIST
            </paper-button>
          </div>

          <iron-pages selected="[[selectedView]]">
            <section>
              <template is="dom-if" if="[[patient]]">
                <paper-card class="organization-info-cards">

                  <div class="card-custom-header">
                    <div class="layout horizontal center">
                      <div class="title flex">Adding Patient: [[$getFullName(patient.name)]]</div>
                    </div>
                  </div>
                  <div class="card-content">

                    <paper-autocomplete label="Search Waitlist To Add Patient" source="[[waitlistSourceMap]]" on-autocomplete-selected="moveToThisWaitlistAutocompleteSelected"></paper-autocomplete>

                    <template is="dom-repeat" items="[[flatWaitListObjectMap]]">
                      <paper-item class="list-item">
                        <div>[[item.path]]</div>
                        <div class="flex"></div>
                        <paper-button class="btn btn-sm btn-primary" on-tap="movePatientToThisWaitListButtonClicked">Add Patient Here</paper-button>
                      </paper-item>
                    </template>

                  </div>
                </paper-card>
              </template>
            </section>

            <section>
              <template is="dom-if" if="[[organization]]">
                <paper-card class="organization-info-cards">
                  <div class="card-custom-header">
                    <div class="horizontal layout center" style="font-weight: bold;">
                      [[organization.name]]
                      <template is="dom-repeat" items="[[currentItemStack]]">
                        &gt;&gt; [[item.name]]
                      </template>
                      <div class="flex"></div>
                      <template is="dom-if" if="[[level]]">
                        <paper-button class="btn btn-default btn-sm" raised="" on-tap="upCurrentItemTapped">Go Back To Previous Level</paper-button>
                      </template>
                      <template is="dom-if" if="[[!shouldShowPatients]]">
                        <paper-button class="btn btn-default btn-sm" raised="" on-tap="showPatientsTapped">Show Patients</paper-button>
                      </template>
                    </div>
                  </div>

                  <div class="card-content">

                    <div class="horizontal layout center">
                      <paper-input class="flex" id="genericEntry" value="{{newGenericItemName}}" label="Waitlist Name" error-message="Enter Name of this Waitlist" required="" type="text" auto-validate="" on-keyup="addNewGenericItemEnterKeyPressed">
                        <div suffix="">
                          <paper-button class="btn btn-primary" raised="" on-tap="addNewGenericItemTapped">Add New Waitlist Here</paper-button>
                        </div>
                      </paper-input>
                    </div>

                    <div class="p-vertical-8">
                      <template is="dom-if" if="[[!genericItemList.length]]">
                        <p class="type danger layout vertical center">Add Some Waitlist...</p>
                      </template>
                      <template id="assistant-list-repeater" is="dom-repeat" items="[[genericItemList]]" as="genericItem">
                        <paper-item class="custom layout horizontal center">
                          <paper-input value="{{genericItem.name}}">
                            <div prefix="" class="type secondary m-right-8">Name: </div>
                          </paper-input>
                          <div class="flex"></div>
                          <paper-button class="btn btn-default btn-sm" raised="" on-tap="genericItemViewSubitemsTapped">Open</paper-button>
                          <paper-button class="btn btn-danger btn-sm" on-tap="genericItemDeleteTapped">Delete</paper-button>
                        </paper-item>
                      </template>
                    </div>
                  </div>
                </paper-card>

                <paper-card class="m-top-16" heading="Waitlist">
                  <div class="card-content">
                    <paper-autocomplete label="Search Waitlist" source="[[waitlistSourceMap]]" on-autocomplete-selected="_getWaitlistRef"></paper-autocomplete>


                    <template is="dom-repeat" items="[[flatWaitListObjectMap]]">
                      <paper-item class="list-item">
                        <div>[[item.path]]</div>
                        <div class="flex"></div>
                        <div class="type secondary">[[item.aggregatedSeatCount]]</div>
                        <paper-button class="btn btn-sm btn-default" on-tap="viewPatientsForThisWaitList">View Patients</paper-button>
                      </paper-item>
                    </template>
                  </div>
                </paper-card>

                <template is="dom-if" if="[[shouldShowPatients]]">
                  <paper-card class="organization-info-cards">

                    <div class="card-custom-header">
                      <div class="layout horizontal center">
                        <div class="title flex">Total [[seatList.length]] patients.</div>
                      </div>
                    </div>

                    <template is="dom-if" if="[[seatList.length]]">
                      <div class="p-0">
                        <template id="assistant-list-repeater" is="dom-repeat" items="[[seatList]]" as="seat">
                          <paper-item class="layout horizontal center waitlist-item">
                            <div class="flex layout vertical">

                              <div class="layout horizontal">
                                <paper-input class="m-right-8 flex" label="Name of Patient" value="{{seat.patientNameCopy}}"></paper-input>
                                <paper-input class="m-right-8 flex" label="Email of Patient" value="{{seat.patientEmailCopy}}"></paper-input>
                                <paper-input class="m-right-8 flex" label="Phone of Patient" value="{{seat.patientPhoneCopy}}"></paper-input>
                              </div>
                              <div class="layout horizontal center">
                                <paper-input class="flex" label="#[[seat.uid]]" value="[[seat.seatDetail]]" disabled=""></paper-input>
                                <template is="dom-if" if="[[isBookedForProcedure]]">
                                  <paper-input class="m-right-8" type="date" label="Procedure Date" value="{{seat.procedureDate}}"></paper-input>
                                  <paper-input label="Procedure Time" type="time" value="{{seat.procedureTime}}"></paper-input>
                                  <paper-button class="btn btn-primary btn-sm" on-tap="bookProecedureConfirmedClick">Confirm Booking</paper-button>
                                </template>
                                <template is="dom-if" if="[[seat.isConfirmedForProcedure]]">
                                  <div class="type caption2 primary">Precdure Confirmed [[$mkDateTime(seat.confirmedForProcedureDatetimeStamp)]]</div>
                                </template>
                              </div>

                            </div>
                            <paper-menu-button horizontal-align="right" no-animations="">
                              <paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
                              <paper-menu class="dropdown-content">
                                <div hidden="">[[seat]]</div>
                                <paper-item on-tap="seatBookForProcedureTapped">Book for Procedure</paper-item>
                                <paper-item on-tap="seatMoveTapped">Move Patient</paper-item>
                                <paper-item on-tap="seatDeleteTapped">Delete From List</paper-item>
                              </paper-menu>
                            </paper-menu-button>
                          </paper-item>
                        </template>
                      </div>
                    </template>
                    <div class="card-actions">
                      <p class="type caption info bold">NOTE: Add patients from Patient Manager</p>
                    </div>
                  </paper-card>
                </template>

              </template>


            </section>

          </iron-pages>

        </template>
        <!-- editing organization - end -->

      </div>

    </div>

  </template>
  <script>(function(){Polymer({is:"page-organization-manage-waitlist",behaviors:[app.behaviors.commonComputes,app.behaviors.dbUsing,app.behaviors.translating,app.behaviors.pageLike,app.behaviors.apiCalling],properties:{selectedView:{type:Number,value:function(){return 1}},shouldShowAdd:{type:Boolean,value:function(){return!0}},isBookedForProcedure:{type:Boolean,value:function(){return!1}},user:{type:Object,notify:!0,value:null},patient:{type:Object,notify:!0,value:null},isOrganizationValid:{type:Boolean,notify:!0,value:!1},organization:{type:Object,notify:!0,value:null},waitlistObject:{type:Object,value:null},newItemDetails:{type:String,value:""},newItemPatientSerial:{type:String,value:""},newItemPatientNameManuallyEntered:{type:String,value:""},seatList:{type:Array,value:function(){return[]}},genericItemList:{type:Array,value:function(){return[]}},level:{type:Number,value:function(){return 0}},currentItemStack:{type:Array,value:function(){return[]}},currentItemListStack:{type:Array,value:function(){return[]}},currentSeatListStack:{type:Array,value:function(){return[]}},shouldShowPatients:{type:Boolean,value:function(){return!1}},flatWaitListObjectMap:{type:Array,value:function(){return[]}}},_loadUser:function(){var t;if(t=app.db.find("user"),1===t.length)return this.user=t[0]},arrowBackButtonPressed:function(t){return this.domHost.navigateToPreviousPage()},_notifyInvalidOrganization:function(){return this.isOrganizationValid=!1,this.domHost.showModalDialog("Invalid Organization Provided")},$getFullName:function(t){var e,i,a,s;return"object"==typeof t?(i="",e="",a="",s="",t.honorifics&&(i=t.honorifics+". "),t.first&&(e=t.first),t.middle&&(s=" "+t.middle),t.last&&(a=" "+t.last),i+e+s+a):t},navigatedIn:function(){var t;if(this.isLoading=!0,this._loadUser(),t=this.domHost.getPageParams(),t.organization?this._loadOrganization(t.organization):this._notifyInvalidOrganization(),t.patient)return this._loadPatient(t.patient),this.set("selectedView",0)},_loadPatient:function(t){var e;if(e=app.db.find("patient-list",function(e){var i;return i=e.serial,i===t}),1===e.length)return this.set("patient",e[0])},navigatedOut:function(){return this.organization=null,this.isOrganizationValid=!1,this.patient=null,this.isBookedForProcedure=!1},_loadOrganization:function(t){var e;return e={apiKey:this.user.apiKey,idList:[t]},this.callApi("/bdemr-organization-list-organizations-by-ids",e,function(t){return function(e,i){return i.hasError?t.domHost.showModalDialog(i.error.message):1!==i.data.matchingOrganizationList.length?void t.domHost.showModalDialog("Invalid Organization"):(t.set("organization",i.data.matchingOrganizationList[0]),t._loadWaitlistObject())}}(this))},_loadWaitlistObject:function(){var t;return t={apiKey:this.user.apiKey,organizationId:this.organization.idOnServer},this.callApi("/bdemr-organization-waitlist-get-object",t,function(t){return function(e,i){return i.hasError?t.domHost.showModalDialog(i.error.message):(t.set("waitlistObject",i.data.waitlistObject),t.set("seatList",t.waitlistObject.seatList),t.set("genericItemList",t.waitlistObject.itemList),t.set("level",0),t.set("isOrganizationValid",!0),t._aggregateWaitList(t.waitlistObject.itemList),t._populateFlatList(t.waitlistObject.itemList),t.isLoading=!1)}}(this))},_getFlatList:function(t){var e,i,a,s,n,r,o,l;for(a=[],s=0,o=t.length;s<o;s++)for(n=t[s],a.push([n.name,n.uid,n.seatList,n.aggregatedSeatCount,n.aggregatedSeatList]),i=this._getFlatList(n.subitemList),r=0,l=i.length;r<l;r++)e=i[r],e.unshift(n.name),a.push(e);return a},_populateFlatList:function(t){var e,i,a,s,n,r,o,l,u,d;for(s=this._getFlatList(t),a=[],n=0,o=s.length;n<o;n++)r=s[n],u=r[r.length-3],d=r[r.length-4],l=r.slice(0,r.length-4).join(" > "),i=r[r.length-1],e=r[r.length-2],a.push({path:l,uid:d,seatList:u||[],aggregatedSeatList:i,aggregatedSeatCount:e});return this.set("flatWaitListObjectMap",a),this.waitlistSourceMap=function(){var t,e,i;for(i=[],t=0,e=a.length;t<e;t++)r=a[t],i.push({text:r.path.split(" > ").reverse().join(" < "),value:r.uid});return i}()},_aggregateSeatList:function(t){var e,i,a,s,n;for(t.seatList||(t.seatList=[]),t.subitemList||(t.subitemList=[]),e=[].concat(t.seatList),s=t.subitemList,i=0,a=s.length;i<a;i++)n=s[i],e=e.concat(this._aggregateSeatList(n));return t.aggregatedSeatList=e,e},_aggregateSeatCount:function(t){var e,i,a,s,n;for(t.seatList||(t.seatList=[]),t.subitemList||(t.subitemList=[]),e=t.seatList.length,s=t.subitemList,i=0,a=s.length;i<a;i++)n=s[i],e+=this._aggregateSeatCount(n);return t.aggregatedSeatCount=e,e},_aggregateWaitList:function(t){var e,i,a,s;for(s=[],e=0,a=t.length;e<a;e++)i=t[e],this._aggregateSeatCount(i),s.push(this._aggregateSeatList(i));return s},_getWaitlistRef:function(t){var e,i;return i=t.detail.value,e=function(){var t,a,s,n;for(s=this.flatWaitListObjectMap,n=[],t=0,a=s.length;t<a;t++)e=s[t],e.uid===i&&n.push(e);return n}.call(this)[0],this.shouldShowPatients=!0,"seatList"in e||(e.seatList=[]),this.set("seatList",e.seatList)},viewPatientsForThisWaitList:function(t){var e;return e=t.model.item,this.shouldShowPatients=!0,"aggregatedSeatList"in e||(e.aggregatedSeatList=[]),this.set("seatList",e.aggregatedSeatList)},saveTapped:function(t){return this._saveWaitlist()},_saveWaitlist:function(t){var e;return e={apiKey:this.user.apiKey,organizationId:this.organization.idOnServer,waitlistObject:this.waitlistObject},this.callApi("/bdemr-organization-waitlist-set-object",e,function(e){return function(i,a){return a.hasError?e.domHost.showModalDialog(a.error.message):(e.domHost.showToast("Saved"),t?t():void 0)}}(this))},addNewGenericItemEnterKeyPressed:function(t){if(13===t.keyCode)return this.$$("#genericEntry").validate(),this.addNewGenericItem()},addNewGenericItemTapped:function(t){return this.$$("#genericEntry").validate(),this.addNewGenericItem()},addNewGenericItem:function(){var t;if(this.newGenericItemName)return"uidSeed"in this.waitlistObject||(this.waitlistObject.uidSeed=0),t={name:this.newGenericItemName,uid:this.waitlistObject.uidSeed++,level:this.level+1,subitemList:[]},this.push("genericItemList",t),this.set("newGenericItemName",""),this._populateFlatList(this.waitlistObject.itemList),this._saveWaitlist()},upCurrentItemTapped:function(t){var e,i,a;return this.shouldShowPatients=!0,e=this.pop("currentItemStack"),this.set("level",this.level-1),0===this.level?this.set("genericItemList",this.waitlistObject.itemList):(i=this.pop("currentItemListStack"),this.set("genericItemList",i)),a=this.pop("currentSeatListStack"),this.set("seatList",a)},genericItemViewSubitemsTapped:function(t){var e;return this.shouldShowPatients=!0,e=t.model.genericItem,this.push("currentItemListStack",this.genericItemList),this.push("currentSeatListStack",this.seatList),this.set("genericItemList",e.subitemList),this.set("level",this.level+1),this.push("currentItemStack",e),"seatList"in e||(e.seatList=[]),this.set("seatList",e.seatList)},showPatientsTapped:function(t){return this.shouldShowPatients=!0},moveToThisWaitlistAutocompleteSelected:function(t){var e,i,a;return i=t.detail.value,e=function(){var t,e,s,n;for(s=this.flatWaitListObjectMap,n=[],t=0,e=s.length;t<e;t++)a=s[t],a.uid===i&&n.push(a);return n}.call(this)[0],t.target.text="",this._movePatientToWaitList(e)},movePatientToThisWaitListButtonClicked:function(t){var e;return e=t.model.item,this._movePatientToWaitList(e)},_movePatientToWaitList:function(t){var e,i,a,s,n,r;"seatList"in t||(t.seatList=[]),this.set("seatList",t.seatList),n=this.seatList;for(i=0,a=n.length;i<a;i++)if(t=n[i],t.patientSerial===this.patient.serial)return void this.domHost.showToast("Patient Already added to this Waitlist");return"seedUidSeed"in this.waitlistObject||(this.waitlistObject.seedUidSeed=0),r={uid:this.waitlistObject.seedUidSeed++,seatDetail:t.path,patientSerial:this.patient.serial,patientNameCopy:this.$getFullName(this.patient.name),patientEmailCopy:this.patient.email,patientPhoneCopy:this.patient.phone,isBookedForProcedure:!1,procedureDate:0,procedureTime:""},this.push("seatList",r),this.shouldShowPatients=!0,this.patient=null,this.set("selectedView",1),s={phone:r.patientPhoneCopy,email:r.patientEmailCopy,category:"waitlist",message:"Added to "+this.organization.name+" > "+r.seatDetail+". Serial Token: "+r.uid},e=s,e.apiKey=this.user.apiKey,this._saveWaitlist(function(t){return function(){return t.domHost.showToast("Patient Moved"),t._sendNotification(e)}}(this))},_sendNotification:function(t){return this.callApi("/extern-scheduler-add-notification",t,function(t){return function(e,i){return i.hasError?t.domHost.showModalDialog("Notification Error: "+i.error.message):t.domHost.showToast("Notification Sent")}}(this))},genericItemDeleteTapped:function(t){var e;return e=t.model.index,this.splice("genericItemList",e,1),this.domHost.showToast("Save Waitlist for changes to take affect")},seatDeleteTapped:function(t){var e;return e=t.model.index,this.splice("seatList",e,1),this._saveWaitlist()},seatMoveTapped:function(t){var e,i,a;return i=t.model,a=i.seat,e=i.index,this.splice("seatList",e,1),this._loadPatient(a.patientSerial),this.selectedView=0},seatBookForProcedureTapped:function(t){var e,i,a;return i=t.model,a=i.seat,e=i.index,this.isBookedForProcedure=!0,this._makeNewVisit(a.patientSerial),this._makeNewNextVisit(a.patientSerial)},bookProecedureConfirmedClick:function(t){var e,i,a,s;if(s=t.model.seat,s.procedureDate&&s.procedureTime)return this.nextVisit.doctorName=this.organization.name+" > "+s.seatDetail.split(" <").reverse().join(" >"),e=new Date(s.procedureDate+" "+s.procedureTime),this.nextVisit.data.nextVisitDateTimestamp=e.getTime(),this._addNextVisitPressed(),t.model.set("seat.isConfirmedForProcedure",!0),t.model.set("seat.confirmedForProcedureDatetimeStamp",e.getTime()),this.isBookedForProcedure=!1,this._saveWaitlist(),a=s.seatDetail.split("<")[0].trim(),i={phone:s.patientPhoneCopy,email:s.patientEmailCopy,category:"waitlist",message:a+" is booked  at "+this.organization.name+" on "+lib.datetime.mkDatetime(e,"mmm d, yyyy h:MMTT"),apiKey:this.user.apiKey},this._sendNotification(i)},_makeNewVisit:function(t){return this.visit={serial:this.generateSerialForVisit(),idOnServer:null,source:"local",createdDatetimeStamp:lib.datetime.now(),lastModifiedDatetimeStamp:0,lastSyncedDatetimeStamp:0,createdByUserSerial:this.user.serial,doctorsPrivateNote:"",patientSerial:t,recordType:"doctor-visit",doctorName:this.user.name,hospitalName:null,doctorSpeciality:null,prescriptionSerial:null,doctorNotesSerial:null,nextVisitSerial:null,advisedTestSerial:null,patientStaySerial:null,invoiceSerial:null,historyAndPhysicalRecordSerial:null,diagnosisSerial:null,identifiedSymptomsSerial:null,recordTitle:null,vitalSerial:{bp:null,hr:null,bmi:null,rr:null,spo2:null,temp:null},testResults:{serial:null,name:null,attachmentSerialList:[]}}},_makeNewNextVisit:function(t){return this.nextVisit={serial:null,lastModifiedDatetimeStamp:0,createdDatetimeStamp:0,lastSyncedDatetimeStamp:0,createdByUserSerial:this.user.serial,visitSerial:this.visit.serial,patientSerial:t,doctorName:"",doctorSpeciality:"",data:{nextVisitDateTimestamp:0,priorityType:""}}},_addNextVisitPressed:function(){this.nextVisit.serial=this.generateSerialForNextVisit(),this.nextVisit.createdDatetimeStamp=lib.datetime.now(),this._updateVisitForNextVisit(this.nextVisit.serial),this._saveNextVisit(this.nextVisit),this.domHost.showToast("Next Visit Added.")},_saveNextVisit:function(t){return t.lastModifiedDatetimeStamp=lib.datetime.now(),app.db.upsert("visit-next-visit",t,function(e){return function(e){var i;return i=e.serial,t.serial===i}}(this))},_updateVisitForNextVisit:function(t){return null===this.visit.nextVisitSerial&&(this.visit.nextVisitSerial=t),this.visit.lastModifiedDatetimeStamp=lib.datetime.now(),app.db.upsert("doctor-visit",this.visit,function(t){return function(e){var i;return i=e.serial,t.visit.serial===i}}(this))}})}).call(this);
//# sourceMappingURL=page-organization-manage-waitlist.coffee-compiled.js.map</script>
</dom-module>