<!-- style --><!-- behavior --><dom-module id="page-test-other-editor">
  <template>
    <style is="custom-style" include="common-style">
      paper-dropdown-menu {
        width: 100%;
      }
      .limiting-container {
        margin-top: 10px;
      }
    </style>

    <div class="master-container">

      <div class="limiting-container">

        <paper-card>
          <paper-tabs class="basic-tabs" selected="{{selectedTestViewIndex}}">
            <paper-tab><iron-icon src="../../images/icons/ico_medicine_flask.png" class="m-right-8"></iron-icon>[[$TRANSLATE('Test',LANG)]]</paper-tab>
            <paper-tab><iron-icon icon="attachment" class="m-right-8"></iron-icon>[[$TRANSLATE('Attachment',LANG)]]</paper-tab>
          </paper-tabs>

          <iron-pages selected="{{selectedTestViewIndex}}">

            <!-- Test - start -->
            <section>
              
              <div class="card-content">
                <div class="form-group">
                  <div><paper-input label="[[$TRANSLATE('Name',LANG)]]" type="text" value="{{otherTest.data.name}}"></paper-input></div>
                  <div><paper-input label="[[$TRANSLATE('Institution',LANG)]]" type="text" value="{{otherTest.data.institution}}"></paper-input></div>
                </div>
                <div class="form-group">
                  <div><paper-input label="[[$TRANSLATE('Result',LANG)]]" type="text" value="{{otherTest.data.result}}"></paper-input></div>
                  <div><paper-input label="[[$TRANSLATE('Unit',LANG)]]" type="text" value="{{otherTest.data.unit}}"></paper-input></div>
                  <vaadin-date-picker label="Date" value="{{otherTest.data.date}}" max="{{currentDate}}"></vaadin-date-picker>
                </div>
              </div>

              <div class="card-actions">
                <template is="dom-if" if="[[isThatNewTest]]">
                  <paper-button class="" on-tap="cancelButtonClicked">Cancel</paper-button>
                  <paper-button class="colored" raised="" on-tap="addOtherTestButtonClicked">Add (5 BDT, Patient)</paper-button>
                </template>
                <template is="dom-if" if="[[!isThatNewTest]]">
                  <paper-button class="btn btn-success" on-click="updateOtherTestPressed" raised="">Update</paper-button>
                </template>
              </div>
            </section>
            <!-- Test - end -->

            <!-- test - start -->
            <section>
              <div class="card-content">
                <template is="dom-if" if="[[newAttachment]]">

                  <div class="horizontal layout wrap">
                    <div class="vertical layout center descriptive-area">
                      <template is="dom-if" if="[[newAttachment.isImage]]">
                        <img class="new-attachment-preview" src$="[[newAttachment.dataUri]]">
                      </template>
                      <template is="dom-if" if="[[!newAttachment.isImage]]">
                        <img class="new-attachment-preview" src="./../../assets/no-preview.png">
                      </template>
                      <paper-progress value="[[newAttachment.progress]]"></paper-progress>
                    </div>
                    <div class="vertical layout descriptive-area">
                      <paper-input class="logo-input" type="file" accept="*/*" on-change="fileInputChanged" no-ink=""></paper-input>

                      <template is="dom-if" if="[[newAttachment.isLoaded]]">

                        <paper-input label="Title" value="{{newAttachment.title}}"></paper-input>

                        <paper-input label="Description" value="{{newAttachment.description}}"></paper-input>

                        <paper-input readonly="" label="Space Needed" value="[[$toMega(newAttachment.sizeInChars)]]MB"></paper-input>

                        <div class="horizontal layout">
                          <div class="layout horizontal center" hidden$="[[!isUploading]]">
                            <paper-spinner style="margin-right: 10px;" active=""></paper-spinner>
                            <paper-button disabled="">UPLOADING...</paper-button>
                          </div>
                          <paper-button raised="" on-tap="uploadPressed" hidden$="[[isUploading]]">UPLOAD</paper-button>
                          <paper-button raised="" on-tap="saveLocallyPressed">SAVE LOCALLY</paper-button>
                          <paper-button raised="" on-tap="keepUntilBrowserClosedPressed">KEEP UNTIL BROWSER IS CLOSED</paper-button>
                        </div>

                      </template>
                    </div>
                  </div>

                </template>

                <div class="layout horizontal center" hidden$="[[!isDownloading]]">
                  <paper-spinner active=""></paper-spinner>
                  <span class="text-muted"> &nbsp; &nbsp; Loading Images...</span>
                </div>
                <template is="dom-if" if="[[attachmentList]]">
                  <div class="attachment-card-list horizontal layout wrap">
                    
                    <template is="dom-repeat" items="[[attachmentList]]" as="attachment" index-as="attachmentIndex">
                      <paper-material elevation="1">
                        <div class="attachment-card vertical layout">
                          <img class="image" src$="[[$getImageSrc(attachment)]]" hidden$="[[!attachment.isImage]]">
                          <div class="footer">
                            <div class="title horizontal layout center">
                              <div class="flex">[[attachment.title]]</div>
                              <paper-icon-button on-tap="downloadPressed" icon="file-download"></paper-icon-button>
                              <paper-icon-button on-tap="deletePressed" icon="delete"></paper-icon-button>
                            </div>
                          </div>
                        </div>
                      </paper-material>
                    </template>

                  </div>
                </template>
              </div>

              <div class="card-actions">
                <div class="usage horizontal layout around-justified center">
                  <div class="vertical layout">
                    <div class="title">[[localDataUsedPercentage]]%</div>
                    <paper-progress value="[[localDataUsedPercentage]]"></paper-progress>
                  </div>
                  <div>You are currently using [[localDataUsedPercentage]]% of your local store capacity for images.</div>
                </div>
              </div>
            </section>
            <!-- Attachment - end -->
          </iron-pages>
          
          

        </paper-card>

      </div>
    </div>

  </template>
  <script>(function(){var t;t=function(t){var e,a,i,n,r,s;for(i=atob(t.split(",")[1]),s=t.split(",")[0].split(":")[1].split(";")[0],e=new ArrayBuffer(i.length),r=new Uint8Array(e),n=0;n<i.length;)r[n]=i.charCodeAt(n),n++;return a=new Blob([e],{type:s})},Polymer({is:"page-test-other-editor",behaviors:[app.behaviors.commonComputes,app.behaviors.dbUsing,app.behaviors.pageLike,app.behaviors.translating,app.behaviors.apiCalling],properties:{selectedTestViewIndex:{type:Number,notify:!0,value:0},user:{type:Object,notify:!0,value:{}},patient:{type:Object,notify:!0,value:{}},isPatientValid:{type:Boolean,notify:!1,value:!0},isThatNewTest:{type:Boolean,notify:!1,value:!0},otherTest:{type:Object,notify:!0,value:{}},currentDate:{type:String,value:function(){return lib.datetime.mkDate(new Date)}},attachmentList:{type:Array,notify:!1,value:function(){return[]}},newAttachment:{type:Object,notify:!1,value:null},localDataUriDb:{type:Object,value:null},maximumImageSizeAllowedInBytes:{type:Number,value:1e7},maximumLocalDataUriDbSizeInChars:{type:Number,value:2e6},localDataUsedPercentage:{type:Number,value:0},currentDateFilterStartDate:{type:Number},currentDateFilterEndDate:{type:Number},isDownloading:{type:Boolean,value:!1},isUploading:{type:Boolean,value:!1}},_loadUser:function(){var t;if(t=app.db.find("user"),1===t.length)return this.user=t[0]},_loadPatient:function(t){var e;return e=app.db.find("patient-list",function(e){var a;return a=e.serial,a===t}),1===e.length?(this.isPatientValid=!0,this.patient=e[0]):this._notifyInvalidPatient()},_makeOtherTest:function(){return this.otherTest={serial:null,createdByUserSerial:this.user.serial,patientSerial:this.patient.serial,createdDatetimeStamp:null,lastModifiedDatetimeStamp:0,lastSyncedDatetimeStamp:0,data:{date:lib.datetime.mkDate(),name:null,institution:null,result:null,unit:null,attachmentSerialList:[]}}},_loadOtherTest:function(t){var e;return e=app.db.find("patient-test-other",function(e){var a;return a=e.serial,a===t}),1===e.length?(this.isTestValid=!0,this.otherTest=e[0],this._loadAttachmentList(this.otherTest.serial),!0):(this._notifyInvalidTest(),!1)},updateOtherTestPressed:function(t){if(this.otherTest.data.name&&this.otherTest.data.result&&this.otherTest.data.unit||this.domHost.showToast("Please Enter All The Data."),this.otherTest.data.name&&this.otherTest.data.result&&this.otherTest.data.unit)return this._saveOtherTest(this.otherTest),this.domHost.showToast("Updated Successfully!"),this._makeOtherTest(),this.arrowBackButtonPressed()},cancelButtonClicked:function(t){return this._makeOtherTest(),this.arrowBackButtonPressed()},arrowBackButtonPressed:function(t){return window.history.back()},_notifyInvalidTest:function(){return this.isTestValid=!1,this.domHost.showModalDialog("Invalid Test Provided!")},_saveOtherTest:function(t){return t.lastModifiedDatetimeStamp=lib.datetime.now(),app.db.upsert("patient-test-other",t,function(e){return function(e){var a;return a=e.serial,t.serial===a}}(this))},addOtherTestButtonClicked:function(){return this.otherTest.data.name&&this.otherTest.data.result&&this.otherTest.data.unit&&this.otherTest.data.institution?this._chargePatient(this.patient.idOnServer,5,"Payment BDEMR Doctor Generic",function(t){return function(e){return e?void t.domHost.showModalDialog("Unable to charge the patient. "+e.message):(t.otherTest.createdDatetimeStamp=lib.datetime.now(),t.otherTest.serial=t.generateSerialForVitals("OT"),t.otherTest.createdByUserSerial=t.user.serial,t.otherTest.patientSerial=t.patient.serial,t._saveOtherTest(t.otherTest),t._makeOtherTest(),t.domHost.showToast("Added Successfully"),t.arrowBackButtonPressed())}}(this)):void this.domHost.showToast("Please Enter All The Data")},_updateSpaceCalculation:function(){var t,e;if(this.localDataUriDb)return t=this.localDataUriDb.computeTotalSpaceTaken(),e=1-(this.maximumLocalDataUriDbSizeInChars-t)/this.maximumLocalDataUriDbSizeInChars,this.localDataUsedPercentage=Math.floor(100*e)},_openLocalDataUriDb:function(){var t,e;return t=new lib.DatabaseEngine({name:"local-data-uri-db",storageEngine:lib.localStorage,serializationEngine:lib.json,config:{commitDelay:0}}),t.initializeDatabase({removeExisting:!1}),t.defineCollection({name:"local-attachment"}),this.localDataUriDb=t,e=new lib.DatabaseEngine({name:"session-data-uri-db",storageEngine:lib.tabStorage,serializationEngine:lib.json,config:{commitDelay:0}}),e.initializeDatabase({removeExisting:!1}),e.defineCollection({name:"local-attachment"}),this.sessionDataUriDb=e},_makeBlankAttachment:function(){return this.set("newAttachment",{title:"",description:"",dataUri:"",originalName:null,originalType:null,sizeInBytes:0,sizeInChars:0,isImage:!1,isLoaded:!1,progress:0})},_loadAttachmentList:function(t){var e,a;return e=app.db.find("patient-gallery--local-attachment",function(e){var a;return a=e.testSerial,a===t}),this.set("attachmentList",e),a=app.db.find("patient-gallery--online-attachment",function(e){var a;return a=e.testSerial,a===t}),a.length&&this.set("isDownloading",!0),lib.util.iterate(a,function(t){return function(e,a,i){return t.callApi("bdemr/get-uploaded-file",{attachmentId:i.data.attachmentId},function(a,i){return i.hasError?t.domHost.showModalDialog(i.error.message):(t.push("attachmentList",i.data),e())})}}(this))["finally"](function(t){return function(){return t.set("isDownloading",!1)}}(this))},_saveAttachment:function(t){return app.db.upsert("patient-gallery--local-attachment",t,function(e){return function(e){var a;return a=e.serial,t.serial===a}}(this))},$toMega:function(t){return Math.ceil(t/1e3/1e3*100)/100},$getImageSrc:function(t){var e;return"local"===t.mainStorage?(e=this.localDataUriDb.find("local-attachment",function(e){var a;return a=e.attachmentSerial,a===t.serial}),e.length>0?e[0].dataUri:"assets/not-found.png"):"server"===t.mainStorage?t.dataURI:"session"===t.mainStorage?(e=this.sessionDataUriDb.find("local-attachment",function(e){var a;return a=e.attachmentSerial,a===t.serial}),e.length>0?e[0].dataUri:"assets/not-found.png"):void 0},fileInputChanged:function(t){var e,a;return a=new FileReader,e=t.target.files[0],e.size>this.maximumImageSizeAllowedInBytes?void this.domHost.showModalDialog("Please provide a file less than "+Math.floor(this.maximumImageSizeAllowedInBytes/1e3/1e3)+"mb in size."):(a.readAsDataURL(e),a.onprogress=function(t){return function(e){return t.set("newAttachment.progress",e.loaded/e.total*100)}}(this),a.onload=function(t){return function(){var i;return i=a.result,t.set("newAttachment.isImage",e.type.indexOf("image/")>-1),t.set("newAttachment.sizeInBytes",e.size),t.set("newAttachment.title",e.name),t.set("newAttachment.dataUri",i),t.set("newAttachment.originalType",e.type),t.set("newAttachment.originalName",e.name),t.set("newAttachment.sizeInChars",i.length),t.set("newAttachment.isLoaded",!0)}}(this))},_prepareAtachment:function(){var t,e,a,i,n,r,s,o,l,h;return s=this.newAttachment,h=s.title,a=s.description,e=s.dataUri,i=s.isImage,n=s.originalName,r=s.originalType,o=s.sizeInBytes,l=s.sizeInChars,t={serial:this.generateSerialForAttachmentBlob(),attSyncSerial:this.generateSerialForAttachmentSync(),lastModifiedDatetimeStamp:lib.datetime.now(),mainStorage:null,title:h,description:a,isImage:i,originalName:n,originalType:r,sizeInBytes:o,sizeInChars:l}},uploadPressed:function(t){var e;return e=this._prepareAtachment(),e.mainStorage="server",e.apiKey=app.db.find("user")[0].apiKey,e.dataURI=this.newAttachment.dataUri,this.set("isUploading",!0),this.callApi("bdemr/file-uploader",e,function(t){return function(a,i){var n;return i.hasError?t.domHost.showModalDialog(i.error.message):(e._id=i.data.attachmentId,t.push("attachmentList",e),t.push("otherTest.data.attachmentSerialList",e.serial),n={serial:e.attSyncSerial,createdDatetimeStamp:0,lastModifiedDatetimeStamp:e.lastModifiedDatetimeStamp,lastSyncedDatetimeStamp:0,patientSerial:t.patient.serial,testSerial:t.otherTest.serial,data:{attachmentId:i.data.attachmentId}},app.db.upsert("patient-gallery--online-attachment",n,function(t){var a;return a=t.serial,a===e.serial}),t.set("isUploading",!1),t.domHost._syncOnlyPatientGallery(function(){return t._makeBlankAttachment()}))}}(this))},saveLocallyPressed:function(t){var e,a,i,n,r,s,o,l;return e=this._prepareAtachment(),e.mainStorage="local",l={attachmentSerial:e.serial,dataUri:this.newAttachment.dataUri},a=this.localDataUriDb.computeTotalSpaceTaken(),n=this.maximumLocalDataUriDbSizeInChars,s=n-a,o=JSON.stringify(l).length,s<o?(i=o-s,r="Sorry. Can not save image. Your browser needs "+this.$toMega(i)+"MB additional storage.",this.domHost.showModalDialog(r)):(this.localDataUriDb.insert("local-attachment",l),this.push("attachmentList",e),this._saveAttachment(e),this._makeBlankAttachment(),this._updateSpaceCalculation())},keepUntilBrowserClosedPressed:function(t){var e,a,i,n,r,s,o,l;if(e=this._prepareAtachment(),e.mainStorage="session",l={attachmentSerial:e.serial,dataUri:this.newAttachment.dataUri},a=this.sessionDataUriDb.computeTotalSpaceTaken(),n=5e7,s=n-a,o=JSON.stringify(l).length,s<o)return i=o-s,r="Sorry. Can not save image. Your browser needs "+this.$toMega(i)+"MB additional storage.",this.domHost.showModalDialog(r);try{return this.sessionDataUriDb.insert("local-attachment",l),this.push("attachmentList",e),this._makeBlankAttachment()}catch(h){return t=h,r="Sorry. Can not save image. Your browser do not have enough memory.",this.domHost.showModalDialog(r)}},deletePressed:function(t){var e,a,i,n;return n=t.model,i=n.attachmentIndex,e=n.attachment,"local"===e.mainStorage?(a=this.localDataUriDb.find("local-attachment",function(t){var a;return a=t.attachmentSerial,a===e.serial}),a.length>0&&this.localDataUriDb.remove("local-attachment",a[0]._id),app.db.remove("patient-gallery--local-attachment",e._id),this.splice("attachmentList",i,1),this._updateSpaceCalculation()):"session"===e.mainStorage?(a=this.sessionDataUriDb.find("local-attachment",function(t){var a;return a=t.attachmentSerial,a===e.serial}),a.length>0&&this.sessionDataUriDb.remove("local-attachment",a[0]._id),app.db.remove("patient-gallery--local-attachment",e._id),this.splice("attachmentList",i,1)):this.callApi("bdemr/delete-uploaded-file",{attachmentId:e._id},function(t){return function(n,r){return r.hasError?t.domHost.showModalDialog(r.error.message):(a=app.db.find("patient-gallery--online-attachment",function(t){var a;return a=t.serial,a===e.attSyncSerial}),a.length>0?(app.db.remove("patient-gallery--online-attachment",a[0]._id),t.splice("attachmentList",i,1),app.db.insert("patient-gallery--online-attachment--deleted",{serial:a[0].serial})):void 0)}}(this))},downloadPressed:function(e){var a,i,n,r,s,o;return i=e.model.attachment,o=this.$getImageSrc(i),0===o.indexOf("data:")?(n=t(o),s=window.URL.createObjectURL(n,{type:i.originalType})):s=o,r=i.originalName,a=window.document.createElement("a"),a.href=s,a.target="_blank",a.download=r,document.body.appendChild(a),a.click(),document.body.removeChild(a)},navigatedIn:function(){var t,e;return t=this.getCurrentOrganization(),t||this.domHost.navigateToPage("#/select-organization"),e=this.domHost.getPageParams(),this._loadUser(),this._loadPatient(e.patient),e.test?("new"===e.test?(this.isThatNewTest=!0,this._makeOtherTest()):(this.isThatNewTest=!1,this._loadOtherTest(e.test)),this._openLocalDataUriDb(),this._makeBlankAttachment(),this._updateSpaceCalculation()):void this._notifyInvalidTest()},navigatedOut:function(){return this.user={},this.patient={},this.isTestValid=!1,this.isPatientValid=!1}})}).call(this);
//# sourceMappingURL=page-test-other-editor.coffee-compiled.js.map</script>
</dom-module>

