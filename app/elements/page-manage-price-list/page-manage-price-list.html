<!-- Custom AutoComplete --><!-- vaadin elements --><!-- style --><!-- behavior --><dom-module id="page-manage-price-list">
  <template>

    <!-- style -->

    <style is="custom-style" include="common-style">
      .limiting-container {
        margin-top: 10px;
        width: 95%;
      }

      .item>* {
        margin-right: 16px;
      }

      .item:nth-child(even) {
        background-color: var(--paper-grey-100);
      }

      .text-mute {
        color: var(--paper-grey-400);
      }

      .pharmacy-item {
        border: 1px solid var(--paper-grey-200);
        border-radius: 3px;
        padding: 10px;
        margin-bottom: 10px;
      }

      .card-custom-header {
        padding: 15px;
        border-bottom: 1px solid var(--paper-grey-200);
        background-color: var(--paper-grey-50);
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }

      .card-custom-header .title {
        font-size: 20px;
        font-weight: 500;
        line-height: 28px;
        color: var(--brand-primary-color);
      }

      .centered-header {
        @apply(--layout-vertical);
        @apply(--layout-center);
      }

      #customItemModal {
        width: 360px;
      }

      #customItemModal h2 {
        margin: 0;
        padding: 15px;
        background-color: #eee;
      }

      paper-progress {
        width: 100%;
        --paper-progress-active-color: var(--paper-orange-500);
      }
    </style>
    <div class="master-container">
      <paper-progress indeterminate="" hidden="[[!loading]]"></paper-progress>

      <div class="limiting-container">

        <template is="dom-if" if="[[!loading]]">

          <paper-card heading="[[organization.name]]"></paper-card>

          <paper-tabs id="categoryTabs" on-iron-activate="categorySelected" scrollable="">
            <template is="dom-repeat" items="[[priceListCategories]]">
              <paper-tab>[[item]]</paper-tab>
            </template>
          </paper-tabs>

          <template is="dom-if" if="[[priceListForSelectedCategory.length]]">

            <paper-card>
              <div class="card-custom-header">
                <div class="title flex">Set Price</div>
                <paper-button class="btn btn-success" raised="" on-tap="addNewItemModalOpen">
                  <iron-icon icon="add"></iron-icon>&nbsp;Add New Item
                </paper-button>
              </div>
              <div class="card-content">
                <vaadin-grid items="[[priceListForSelectedCategory]]">
                  <vaadin-grid-column width="150px" flex-grow="0">
                    <template class="header">BADAS Price</template>
                    <template>
                      <input is="iron-input" bind-value="{{item.actualCost}}" placeholder="Actual Cost" on-change="actualCostChanged">
                    </template>
                  </vaadin-grid-column>
                  <vaadin-grid-column width="180px" flex-grow="0">
                    <template class="header">UHCP Discounted Price</template>
                    <template>
                      <input is="iron-input" bind-value="{{item.price}}" placeholder="Price" on-change="priceChanged">
                    </template>
                  </vaadin-grid-column>
                  <vaadin-grid-column flex-grow="1">
                    <template class="header layout horizontal">
                      <vaadin-grid-sorter path="name" direction="asc">
                        <vaadin-grid-filter aria-label="Name" path="name" value="[[searchString]]">
                          <paper-input label="Search By Name" value="{{searchString}}" no-label-float=""></paper-input>
                        </vaadin-grid-filter>
                      </vaadin-grid-sorter>
                    </template>
                    <template>
                      <div>[[item.name]]</div>
                    </template>
                  </vaadin-grid-column>
                  <vaadin-grid-column>
                    <template>
                      <span class="type secondary text-right">[[item.subCategory]]</span>
                    </template>
                  </vaadin-grid-column>
                  <vaadin-grid-column width="80px" flex-grow="0">
                    <template class="header">Action</template>
                    <template>
                      <paper-icon-button icon="delete" on-tap="deleteItemPressed"></paper-icon-button>
                    </template>
                  </vaadin-grid-column>
                </vaadin-grid>
              </div>
            </paper-card>

          </template>

        </template>

      </div>

    </div>

    <!--Modal for Custom Unit and Price-->
    <paper-dialog id="customItemModal" no-cancel-on-esc-key="" no-cancel-on-outside-click="">
      <h2>Add New Item</h2>
      <paper-dialog-scrollable>
        <div class="layout vertical p-horizontal-16">
          <paper-input autofocus="" label="Unit Name" value="{{customItem.name}}" required="" auto-validate=""></paper-input>
          <paper-input label="Retail Price" type="number" value="{{customItem.price}}" required="" auto-validate=""></paper-input>
          <paper-input label="Cost" type="number" value="{{customItem.actualCost}}"></paper-input>
          <paper-input label="Quantity" type="number" value="{{customItem.qty}}"></paper-input>
          <vaadin-combo-box class="category-combo-box" label="Category" items="[[priceListCategories]]" allow-custom-value="" value="{{customItem.category}}" selected-item="{{customItem.category}}" required="" auto-validate="">
          </vaadin-combo-box>
          <paper-input label="Subcategory" value="{{customItem.subCategory}}"></paper-input>
        </div>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button class="btn btn-default" dialog-dismiss="">Cancel</paper-button>
        <paper-button class="btn btn-primary" raised="" on-tap="addNextItemPressed">Add Next</paper-button>
        <paper-button class="btn btn-success" raised="" on-tap="addNewItemAndClosePressed">Add &amp; Close</paper-button>
      </div>
    </paper-dialog>

  </template>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.7.2/localforage.nopromises.min.js"></script>
  <script>(function(){Polymer({is:"page-manage-price-list",behaviors:[app.behaviors.dbUsing,app.behaviors.pageLike,app.behaviors.translating,app.behaviors.apiCalling],properties:{user:{type:Object,notify:!0,value:{}},organization:{type:Object,notify:!0,value:{}},selectedCategoryViewIndex:{type:Number,value:function(){return 0}},priceListForSelectedCategory:{type:Array,value:function(){return[]}},priceList:{type:Object,value:function(){return{}}},priceListCategories:{type:Array,value:function(){return[]}},customItem:{type:Object,value:function(){return this._makeCustomItem()}},loading:{type:Boolean,value:function(){return!1}}},observers:["updatePriceList(priceListForSelectedCategory.splices)"],_updateToDb:function(t,e){return localforage.getItem("organization-price-list").then(function(e){return function(e){var i;return i=e.findIndex(function(e){return t.serial===e.serial}),i===-1?e.push(t):e.splice(i,1,t),localforage.setItem("organization-price-list",e)}}(this)).then(function(t){return function(){return e()}}(this))["catch"](function(t){return function(e){return t.domHost.showModalDialog("Something Went Wrong")}}(this))},_deleteFromDb:function(t,e){return localforage.getItem("organization-price-list").then(function(e){return function(e){var i;return i=e.findIndex(function(e){return e.serial===t.serial}),i>-1&&e.splice(i,1),localforage.setItem("organization-price-list",e)}}(this)).then(function(t){return function(){return localforage.getItem("organization-price-list--deleted")}}(this)).then(function(e){return function(e){return e||(e=[]),e.push({serial:t.serial}),localforage.setItem("organization-price-list--deleted",e)}}(this)).then(function(t){return function(){return e()}}(this))["catch"](function(t){return function(e){return t.domHost.showModalDialog("Something Went Wrong")}}(this))},navigatedIn:function(){var t;return this._loadUser(),t=this.domHost.getPageParams(),this._checkOrganizationAccess(t.organization)?t.organization?(this.loading=!0,this._loadOrganization(t.organization,function(t){return function(e){return t.set("organization",e),t._checkUserAccess(t.user.idOnServer,e.userList,function(i){return i?t._loadPriceList(e.idOnServer,function(e){return t.loading=!1,t._loadCategories(e),t.showPriceListForSelectedCategory(0),t.async(function(){return t.$$("#categoryTabs").selectIndex(0)})}):(t._notifyInvalidAccess(),t.loading=!1)})}}(this))):void this._notifyInvalidOrganization():this._notifyInvalidOrganization()},_loadUser:function(){var t;if(t=app.db.find("user"),1===t.length)return this.user=t[0]},_checkUserAccess:function(t,e,i){var n,r,o,a;for(r=0,o=e.length;r<o;r++)n=e[r],n.id===t&&(a=n);return i(a.isAdmin)},_loadOrganization:function(t,e){var i;return i={apiKey:this.user.apiKey,idList:[t]},this.callApi("/bdemr-organization-list-organizations-by-ids",i,function(t){return function(i,n){return n.hasError?(t.domHost.showModalDialog(n.error.message),t.loading=!1):1!==n.data.matchingOrganizationList.length?void t.domHost.showModalDialog("Invalid Organization"):e(n.data.matchingOrganizationList[0])}}(this))},_notifyInvalidOrganization:function(){return this.isOrganizationValid=!1,this.domHost.showModalDialog("Invalid Organization Provided")},_notifyInvalidAccess:function(){return this.domHost.showModalPrompt("You Do Not Have Access To This Page!",function(t){return function(){}}(this))},_getLastSyncedDatetime:function(){return parseInt(window.localStorage.getItem("priceListLastSyncedDatetimeStamp"))},_prepareNewItemForDB:function(t,e){return Object.assign(t,{serial:this.generateSerialForPriceListItem(this.organization.idOnServer,e),organizationId:this.organization.idOnServer,createdDatetimeStamp:lib.datetime.now(),lastModifiedDatetimeStamp:lib.datetime.now(),createdByUserSerial:this.user.serial})},_preparePriceListData:function(t){var e,i,n,r,o,a;for(a=[],e=n=0,r=t.length;n<r;e=++n)i=t[e],o=this._prepareNewItemForDB(i,e),o.actualCost=o.actualCost||i.price,o.qty=o.qty||null,a.push(o);return a},_createNewPriceList:function(t,e){return this.domHost.getStaticData("uhcpInvoicePriceList",function(t){return function(i){var n;return n=t._preparePriceListData(i),e(n)}}(this))},_getCategoriesFromPriceListData:function(t){var e;return e=t.reduce(function(t){return function(t,e){return t[e.category]=null,t}}(this),{}),Object.keys(e)},_loadPriceList:function(t,e){var i;return i=this._getLastSyncedDatetime(),i?localforage.getItem("organization-price-list").then(function(t){return function(i){if(null!=i?i.length:void 0)return t.set("priceList",i),e(i)}}(this))["catch"](function(t){return function(e){return t.domHost.showModalDialog("Something Went Wrong")}}(this)):this.domHost._syncPriceListOnly(function(t){return function(e){return e?t.async(function(){return t.domHost.showModalDialog(e)}):t.domHost.reloadPage()}}(this))},_loadCategories:function(t){var e;return e=this._getCategoriesFromPriceListData(t),this.set("priceListCategories",e)},showPriceListForSelectedCategory:function(t){var e,i;return i=this.priceListCategories[t],e=this.priceList.filter(function(t){return t.category===i}),this.set("priceListForSelectedCategory",e)},_addToCustomInvestigation:function(t){var e,i;return i=this.generateSerialForCustomInvestigation(),e={serial:i,lastModifiedDatetimeStamp:lib.datetime.now(),createdDatetimeStamp:lib.datetime.now(),lastSyncedDatetimeStamp:0,createdByUserSerial:this.user.serial,visitSerial:null,patientSerial:null,data:{name:t.name,investigationId:i,investigationList:[{name:t.name,referenceRange:"",unitList:[]}]}},app.db.insert("custom-investigation-list",e)},addNewItemToPriceList:function(t){var e,i;return this.push("priceList",t),this.priceListCategories.indexOf(t.category)===-1&&(this._loadCategories(this.priceList),i=this.priceListCategories.length-1,this.async(function(t){return function(){return t.$$("#categoryTabs").selectIndex(i)}}(this))),e=this.$$("#categoryTabs").selected,this.async(function(t){return function(){return t.showPriceListForSelectedCategory(e)}}(this)),"Investigation"===t.category&&this._addToCustomInvestigation(t),this._updateToDb(t,function(t){return function(){return t.domHost.showSuccessToast("Saved")}}(this))},removeItemFromPriceList:function(t){var e;return e=this.priceList.findIndex(function(e){return function(e){return e.serial===t.serial}}(this)),this.splice("priceList",e,1),this.priceListForSelectedCategory.length||(this._loadCategories(this.priceList),this.async(function(t){return function(){return t.$$("#categoryTabs").selectIndex(0)}}(this)),this.async(function(t){return function(){return t.showPriceListForSelectedCategory(0)}}(this))),this._deleteFromDb(t,function(t){return function(){return null}}(this))},_validateCustomItem:function(t){if("object"==typeof t)return t.name?t.price?!!t.category||(this.domHost.showWarningToast("Category is required"),!1):(this.domHost.showWarningToast("Price is required"),!1):(this.domHost.showWarningToast("Name is required"),!1)},_makeCustomItem:function(t){return null==t&&(t={}),Object.assign({name:"",price:null,actualCost:null,qty:null,category:"",subCategory:""},t)},updatePriceList:function(t){if(t)return t.indexSplices.forEach(function(t){return function(e){var i,n,r,o,a,s;for(e.removed.forEach(function(e){return t.removeItemFromPriceList(e)}),s=[],i=r=0,a=e.addedCount;0<=a?r<a:r>a;i=0<=a?++r:--r)n=e.index+i,o=e.object[n],s.push(t.addNewItemToPriceList(o));return s}}(this))},actualCostChanged:function(t){var e;return e=t.model.item,e.lastModifiedDatetimeStamp=lib.datetime.now(),this._updateToDb(e,function(t){return function(){return t.domHost.showSuccessToast("Saved")}}(this))},priceChanged:function(t){var e;return e=t.model.item,e.lastModifiedDatetimeStamp=lib.datetime.now(),this._updateToDb(e,function(t){return function(){return t.domHost.showSuccessToast("Saved")}}(this))},categorySelected:function(t){var e;return e=t.detail.selected,this.async(function(t){return function(){return t.showPriceListForSelectedCategory(e)}}(this))},deleteItemPressed:function(t){return this.domHost.showModalPrompt("Are you sure to delete this item",function(e){return function(i){var n;if(i)return n=e.priceListForSelectedCategory.findIndex(function(e){return e.serial===t.model.item.serial}),e.splice("priceListForSelectedCategory",n,1)}}(this))},saveButtonPressed:function(){return this.domHost.showSuccessToast("Data Saved")},addNewItemModalOpen:function(){return this.$.customItemModal.toggle()},addNewItemAndClosePressed:function(){var t,e,i;if(t=this.get("customItem"),i=this._validateCustomItem(t))return e=this._prepareNewItemForDB(t,this.priceList.length+1),this.unshift("priceListForSelectedCategory",e),this.$$("#customItemModal").toggle(),this.set("customItem",{}),this.domHost.showSuccessToast("Item Added and Saved")},addNextItemPressed:function(){var t,e,i;if(t=this.get("customItem"),i=this._validateCustomItem(t))return e=this._prepareNewItemForDB(t,this.priceList.length+1),this.addNewItemToPriceList(e),this.set("customItem",this._makeCustomItem({category:t.category,subCategory:t.subCategory})),this.domHost.showSuccessToast("Item Added and Saved")},_checkOrganizationAccess:function(t){return t===app.config.masterOrganizationId&&this.getCurrentOrganization().idOnServer===app.config.masterOrganizationId}})}).call(this);
//# sourceMappingURL=page-manage-price-list.coffee-compiled.js.map</script>
</dom-module>