<!-- paper-* --><!-- style --><!-- behavior --><!-- custom-elements --><!-- element --><div hidden="" by-polymer-bundler=""><link rel="import" href="../custom-vital-search/custom-vital-search.html"></div><dom-module id="page-invoice-manager">
  <template>

    <!-- style -->

    <style is="custom-style" include="common-style">
      .limiting-container {
        margin-top: 10px;
        width: 90%;
      }


      .card-custom-header {
        padding: 15px;
        border-bottom: 1px solid var(--paper-grey-200);
        background-color: var(--paper-grey-50);
      }

      .card-custom-header .title {
        font-size: 20px;
        font-weight: 500;
        line-height: 28px;
        color: var(--brand-primary-color);
      }

      .header {
        background-color: var(--paper-grey-100);
        padding: 15px;
      }

      .label {
        background-color: var(--paper-grey-100);
        padding: 5px;
      }

      paper-progress {
        width: 100%;
        --paper-progress-active-color: var(--paper-teal-500);
      }

      .fixed {
        min-width: 100px;
        text-align: right;
      }

      .filter {
        margin-bottom: 5px;
      }


      .paper-custom {
        background-color: #fafafa;
        border: 1px solid #dadada;
        padding: 0px 8px 12px 8px;
        margin: 4px;
        margin-left: 0;
      }
    </style>

    <!-- local DOM -->

    <div class="master-container">

      <div class="limiting-container">

        <!-- Card - Search - start -->
        <paper-card>

          <div class="card-custom-header">
            <div class="layout horizontal center">
              <div class="title flex">Invoice Manager</div>
              <custom-vital-search on-date-select="invoiceCustomSearchClicked" on-clear="invoiceSearchClearButtonClicked"></custom-vital-search>
            </div>
          </div>

          <paper-progress indeterminate="" hidden$="[[!getBoolean(loadingCounter)]]"></paper-progress>

          <div class="card-content">
            <div class="layout horizontal center filter">
              <div class="layout horizontal center paper-custom">
                <!-- <paper-autocomplete id="invoiceSearchInput" label="Search By Investigation" source="[[investigationNameSourceDataList]]"
                  text="{{investigationQuery}}" on-autocomplete-reset-blur="resetInvestigationSearchPressed">
                </paper-autocomplete> -->
                <paper-input label="Search Invoice" value="{{investigationQuery}}" on-keyup="invoiceSearchKeyPressed"></paper-input>
                <paper-button class="btn btn-primary" on-tap="searchByInvestigationPressed">Search</paper-button>
              </div>
              <div class="paper-custom">
                <paper-dropdown-menu label="Filter by Category">
                  <paper-listbox class="dropdown-content" on-iron-activate="categorySelected">
                    <template is="dom-repeat" items="[[categoryList]]">
                      <paper-item>[[item]]</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
              </div>
            </div>
            <br>

            <vaadin-grid items="[[matchingInvoiceList]]" id="inoviceListGrid">
              <vaadin-grid-column width="100px" flex-grow="0">
                <template class="header">
                  <vaadin-grid-sorter path="serial">Serial</vaadin-grid-sorter>
                </template>
                <strong class="label">[[item.serial]]</strong>
              </vaadin-grid-column>
              <vaadin-grid-column>
                <template class="header">
                  <vaadin-grid-sorter path="createdDatetimeStamp" direction="desc">Date</vaadin-grid-sorter>
                </template>
                <template>
                  <div>[[$formatDateTime(item.createdDatetimeStamp)]]</div>
                </template>
              </vaadin-grid-column>
              <vaadin-grid-column>
                <template class="header">
                  <span>Total Billed</span>
                </template>
                <template>
                  <div>[[item.totalBilled]]</div>
                </template>
              </vaadin-grid-column>
              <vaadin-grid-column>
                <template class="header">
                  <span>Discount</span>
                </template>
                <template>
                  <div>[[item.discount]]</div>
                </template>
              </vaadin-grid-column>
              <vaadin-grid-column>
                <template class="header">
                  <span>Total Received</span>
                </template>
                <template>
                  <div>[[item.totalAmountReceieved]]</div>
                </template>
                <template class="footer">
                  <strong>[[$formatCurrency(totalInvoiceIncome)]]</strong>
                </template>
              </vaadin-grid-column>
              <vaadin-grid-column>
                <template class="header">
                  <span>Due</span>
                </template>
                <template>
                  <div>[[calculateDue(item.totalBilled, item.totalAmountReceieved)]]</div>
                </template>
              </vaadin-grid-column>
              <vaadin-grid-column>
                <template class="header">
                  <span>Profit</span>
                </template>
                <template>
                  <div>[[calculateProfit(item)]]</div>
                </template>
                <template class="footer">
                  <strong>[[$formatCurrency(totalProfit)]]</strong>
                </template>
              </vaadin-grid-column>
              <vaadin-grid-column>
                <template class="header">Action
                  <span></span>
                </template>
                <template>
                  <div>
                    <paper-icon-button icon="launch" on-tap="viewInvoiceButtonPressed"></paper-icon-button>
                  </div>
                </template>
              </vaadin-grid-column>
            </vaadin-grid>

          </div>

      </paper-card></div>

    </div>



  </template>
  <script>(function(){Polymer({is:"page-invoice-manager",behaviors:[app.behaviors.translating,app.behaviors.pageLike,app.behaviors.apiCalling,app.behaviors.commonComputes,app.behaviors.dbUsing],properties:{user:{type:Object,value:{}},organization:{type:Object,value:{}},invoiceList:{type:Array,notify:!0,value:[]},matchingInvoiceList:{type:Array,notify:!0,value:[]},totalInvoiceIncome:{type:Number,value:0},totalProfit:{type:Number,value:0},investigationNameSourceDataList:{type:Array,value:function(){return[]}},categoryList:{type:Array,value:function(){return["All","Investigation","Doctor Fees","Services","Supplies","Ambulance","Package","Other"]}},loadingCounter:{type:Number,value:function(){return 0}}},observers:["_calculateTotalProfit(matchingInvoiceList.splices)","_calculateTotalInvoiceIncome(matchingInvoiceList.splices)"],_sortByDate:function(t,e){return t.createdDatetimeStamp<e.createdDatetimeStamp?1:t.createdDatetimeStamp>e.createdDatetimeStamp?-1:void 0},$isAdmin:function(t,e){var i,n,a;for(i=0,n=e.length;i<n;i++)if(a=e[i],t===a.id)return a.isAdmin;return!1},getBoolean:function(t){return!!t},_calculateTotalInvoiceIncome:function(){var t,e,i,n,a;for(a=0,n=this.matchingInvoiceList,t=0,i=n.length;t<i;t++)e=n[t],a+=parseInt(null!=e.totalAmountReceieved?e.totalAmountReceieved:e.totalAmountReceieved=0);return this.set("totalInvoiceIncome",a)},_calculateTotalProfit:function(){var t,e,i,n,a;for(a=0,n=this.matchingInvoiceList,t=0,i=n.length;t<i;t++)e=n[t],a+=this.calculateProfit(e);return this.set("totalProfit",a)},calculateDue:function(t,e){return null==t&&(t=0),null==e&&(e=0),t-e},calculateProfit:function(t){var e,i,n,a,o,r;if(t){for(r=0,a=t.data,e=0,n=a.length;e<n;e++)i=a[e],o=(null!=i.actualCost?i.actualCost:i.actualCost=0)*i.qty,r+=o;return t.totalAmountReceieved-r}},navigatedIn:function(){return this._loadUser(),this._loadOrganization(function(t){return function(e){return t._loadInvoice(e,100,1,function(){}),t._loadInvestigationAutocomplete()}}(this))},_loadUser:function(){var t;if(t=app.db.find("user"),1===t.length)return this.user=t[0]},_loadOrganization:function(t){var e,i;return(i=this.getCurrentOrganization().idOnServer)?(e={apiKey:this.user.apiKey,idList:[i]},this.loadingCounter+=1,this.callApi("/bdemr-organization-list-organizations-by-ids",e,function(e){return function(i,n){return n.hasError?(e.domHost.showModalDialog(n.error.message),e.loadingCounter-=1):(e.loadingCounter-=1,1!==n.data.matchingOrganizationList.length?void e.domHost.showModalDialog("Invalid Organization"):(e.set("organization",n.data.matchingOrganizationList[0]),t(e.organization.idOnServer)))}}(this))):void this._notifyInvalidOrganization()},_loadInvoice:function(t,e,i,n){var a;return null==e&&(e=100),null==i&&(i=1),a={apiKey:this.user.apiKey,organizationId:t,size:e,page:i},this.loadingCounter+=1,this.callApi("bdemr-clinic-app-get-organization-invoice",a,function(t){return function(e,i){var a;return i.hasError?(t.domHost.showModalDialog(i.error.message),t.loadingCounter-=1):(t.loadingCounter-=1,a=i.data,t.set("invoiceList",a),t.set("matchingInvoiceList",a),n())}}(this))},_notifyInvalidOrganization:function(){return this.domHost.showModalDialog("No Organization is Present. Please Select an Organization first.")},invoiceCustomSearchClicked:function(t){var e,i,n,a;return a=new Date(t.detail.startDate),e=new Date(t.detail.endDate),e.setHours(24+e.getHours()),i=function(){var t,i,o,r,s;for(o=this.invoiceList,s=[],t=0,i=o.length;t<i;t++)n=o[t],a.getTime()<=(r=new Date(n.createdDatetimeStamp).getTime())&&r<=e.getTime()&&s.push(n);return s}.call(this),this.set("matchingInvoiceList",i)},invoiceSearchClearButtonClicked:function(t){return this.set("matchingInvoiceList",this.invoiceList)},viewInvoiceButtonPressed:function(t){var e;return e=t.model.item,this.domHost.navigateToPage("#/print-invoice/invoice:"+e.serial+"/patient:"+e.patientSerial)},_loadInvestigationAutocomplete:function(){return this.domHost.getStaticData("investigationList",function(t){return function(e){var i;return t.investigationNameSourceDataList=function(){var t,n,a;for(a=[],t=0,n=e.length;t<n;t++)i=e[t],a.push({text:i.name,value:i.investigationId});return a}()}}(this))},searchByInvestigationPressed:function(){var t,e;if(this.investigationQuery)return e=this.investigationQuery.toLowerCase(),t=this.invoiceList.filter(function(t){return t.data.some(function(t){var i;return(null!=(i=t.name)?i.toLowerCase().indexOf(e):void 0)!==-1})}),this.set("matchingInvoiceList",t)},resetInvestigationSearchPressed:function(t){return this.set("matchingInvoiceList",this.invoiceList)},invoiceSearchKeyPressed:function(t){var e,i;if(13===t.which)return i=t.target.value,e=this.invoiceList.filter(function(t){return t.data.some(function(t){var e;return(null!=(e=t.name)?e.toLowerCase().indexOf(i):void 0)!==-1})}),this.set("matchingInvoiceList",e)},categorySelected:function(t){var e;switch(e=t.detail.selected){case 0:return this.resetInvestigationSearchPressed();case 1:return this._filterInvoiceByCategory("investigation");case 2:return this._filterInvoiceByCategory("doctor-fees");case 3:return this._filterInvoiceByCategory("services");case 4:return this._filterInvoiceByCategory("supplies");case 5:return this._filterInvoiceByCategory("ambulance");case 6:return this._filterInvoiceByCategory("package");case 7:return this._filterInvoiceByCategory("other")}},_filterInvoiceByCategory:function(t){var e;return e=this.invoiceList.filter(function(e){return e.data.some(function(e){var i;return(null!=(i=e.category)?i.toLowerCase():void 0)===t})}),this.set("matchingInvoiceList",e)}})}).call(this);
//# sourceMappingURL=page-invoice-manager.coffee-compiled.js.map</script>
</dom-module>