<link rel="import" href="../../behaviors/common-computes.html">
<link rel="import" href="../../behaviors/db-using.html">
<link rel="import" href="../../behaviors/translating.html">
<link rel="import" href="../../behaviors/api-calling.html">

<link rel="import" href="../../bower-assets/paper-button/paper-button.html">
<link rel="import" href="../../bower-assets/paper-card/paper-card.html">
<link rel="import" href="../../bower-assets/paper-input/paper-input.html">
<link rel="import" href="../../bower-assets/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower-assets/paper-menu/paper-menu.html">
<link rel="import" href="../../bower-assets/paper-item/paper-item.html">
<link rel="import" href="../../bower-assets/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower-assets/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower-assets/paper-icon-button/paper-icon-button.html">
<!-- custom-elements -->
<link rel="import" href="../html-block/html-block.html">

<link rel="import" href="../../styles/common-style.html">
<link rel="import" href="visit-common-styles.html">

<dom-module id="element-print-preview">
  <template>
    <style is="custom-style" include="common-style visit-common-styles">
    </style>


    <div id="printPreview">

      <div class="print-header horizontal layout center center-justified">
        <h1>[[settings.printDecoration.headerLine]]</h1>
      </div>

      <!-- Print Header - Main - start -->
      <div class="document-header horizontal layout center">
        <template is="dom-if" if="[[settings.printDecoration.logoDataUri]]">
          <img class="logo" src="[[settings.printDecoration.logoDataUri]]" alt="">
        </template>

        <div class="leftSide">
          <div class="leftSideLine1">[[settings.printDecoration.leftSideLine1]]</div>
          <div class="leftSideLine2">[[settings.printDecoration.leftSideLine2]]</div>
          <div class="leftSideLine3">[[settings.printDecoration.leftSideLine3]]</div>
        </div>
        <div class="flex"></div>
        <div class="rightSide layout end-justified">
          <div class="rightSideLine1">[[settings.printDecoration.rightSideLine1]]</div>
          <div class="rightSideLine2">[[settings.printDecoration.rightSideLine2]]</div>
          <div class="rightSideLine3">[[settings.printDecoration.rightSideLine3]]</div>
        </div>
      </div>
      <!-- Print Header - Main - end -->

      <!-- Print Header - Patient Details - start -->
      <div class="document-header horizontal layout center p-vertical-8">
        <template is="dom-if" if="[[!patient.isForOrganizationOnly]]">
          <div class="m-horizontal-4">
            <strong>Patient Serial: </strong>
            <span>{{patient.serial}}</span>
          </div>
          <div class="m-horizontal-4">
            <strong>Patient Name: </strong>
            <span>{{patient.name}}</span>
          </div>
          <div class="m-horizontal-4">
            <strong>Sex: </strong>
            <span></span>
          </div>
          <div class="m-horizontal-4">
            <strong>Age: </strong>
            <span>[[_computeAge(patient.dob)]] years </span>
          </div>
          <div class="m-horizontal-4">
            <strong>Blood Group: [[patient.bloodGroup]] </strong>
            <span> </span>
          </div>
          <div class="m-horizontal-4">
            <strong>Allergy: [[patient.allergy]]</strong>
            <span> </span>
          </div>
        </template>

        <template is="dom-if" if="[[patient.isForOrganizationOnly]]">
          <div class="m-horizontal-4">
            <strong>Patient Name: </strong>
            <i></i>
          </div>
          <div class="m-horizontal-4">
            <strong>Age: </strong>
            <i>REDACTED FOR CONFIDENTIALITY</i>
          </div>
          <div class="m-horizontal-4">
            <strong>Blood Group: [[patient.bloodGroup]]</strong>
            <span> </span>
          </div>
          <div class="m-horizontal-4">
            <strong>Allergy: [[patient.allergy]]</strong>
            <span> </span>
          </div>
        </template>
      </div>
      <!-- Print Header - Patient Details - end -->

      <!-- Print Header - record Title - start -->
      <div class="p-16 horizontal layout center center-justified" hidden$="{{!printPrescriptionOnly}}">
        <div class="type headline">{{visit.recordTitle}}</div>
      </div>
      <!-- Print Header - record Title - start -->

      <!-- Print Content [FULL] - start -->
      <div class="print-content" hidden$="{{printPrescriptionOnly}}">
        <!-- Print Content - Left - start -->
        <div class="left">

          <!-- Print - Symptoms - start -->
          <template is="dom-if" if="[[!_isEmpty(addedIdentifiedSymptomsList.length)]]">
            <div class="horizontal layout center print-sub-header">
              <div class="type body">Symptoms</div>
            </div>
            <template is="dom-repeat" items="[[addedIdentifiedSymptomsList]]">
              <div class="type caption-2">
                <span class="type secondary">[[_returnSerial(index)]]. </span>
                <span>{{item.name}}</span>
                <template is="dom-if" if="[[_compareFn(item.possibleValueList.length, '>', 0)]]">
                  (
                  <template is="dom-repeat" items="[[item.possibleValueList]]">
                    <span>{{item}}, </span>
                  </template>)
                </template>
              </div>
            </template>
            <div class="b-top m-top-8"></div>
          </template>
          <!-- Print - Symptoms - end -->

          <!-- Print - Examination - start -->
          <template is="dom-if" if="[[!_isEmpty(addedExaminationList2.length)]]">
            <div class="horizontal layout center print-sub-header">
              <div class="type body">Examination</div>
            </div>
            <template is="dom-repeat" items="[[addedExaminationList2]]" as="examination">
              <div class="type caption-2">
                <span class="type secondary">[[_returnSerial(index)]]. </span>
                <span>{{examination.name}}</span>
                (
                <template is="dom-repeat" items="[[examination.examinationValueList]]" as="examItem">
                  <span hidden$="{{!examItem.checked}}">{{examItem.value}}, </span>
                </template>)
              </div>
            </template>
            <div class="b-top m-top-8 "></div>
          </template>
          <!-- Print - Examination - end -->

          <!-- Print - Vitals - start -->
          <template is="dom-if" if="[[!_isEmpty(addedVitalList.length)]]">
            <div class="horizontal layout center print-sub-header">
              <div class="type body">Vitals</div>
            </div>
            <template is="dom-repeat" items="[[addedVitalList]]">
              <div class="type caption-2">
                <strong>{{item.vitalType}}: </strong>
                <span>[[_pritifyVitalData(item)]]</span>
              </div>
            </template>
            <div class="b-top m-top-8"></div>
          </template>
          <!-- Print - Vitals - end -->

          <!-- Print - Test Advised - start -->
          <template is="dom-if" if="[[!_isEmpty(addedInvestigationList.length)]]">
            <div class="horizontal layout center print-sub-header">
              <div class="type body">Advised Test</div>
            </div>
            <template is="dom-repeat" items="[[addedInvestigationList]]">
              <div class="type caption-2 layout horizontal">
                <div class="type secondary m-right-8">[[_returnSerial(index)]]. </div>
                <div class="flex vertical layout">
                  <div>{{item.investigationName}}</div>
                  <template is="dom-if" if="[[_compareFn(item.testList.length, '==', 1)]]">
                    <ol class="order-list">
                      <li>{{item.testList.0.name}}</li>
                    </ol>
                  </template>
                  <template is="dom-if" if="[[_compareFn(item.testList.length, '>', 1)]]">
                    <ol class="order-list">
                      <template is="dom-repeat" items="[[item.testList]]">
                        <li>{{item.name}}</li>
                      </template>
                    </ol>
                  </template>
                </div>
                <template is="dom-if" if="[[item.suggestedInstitutionName]]">
                  <div class="type caption secondary m-left-16">
                    <strong>Suggested Institution: </strong>
                    <span class="flex">{{item.suggestedInstitutionName}}</span>
                  </div>
                </template>
              </div>
            </template>
            <div class="b-top"></div>
          </template>
          <!-- Print - Test Advised - end -->

          <!-- Print - Diagnosis - start -->
          <template is="dom-if" if="{{!_isEmpty(diagnosis.data.diagnosisList.length)}}">
            <div class="horizontal layout center print-sub-header">
              <div class="type body">Diagnosis</div>
            </div>
            <template is="dom-repeat" items="[[diagnosis.data.diagnosisList]]">
              <div class="type caption-2">
                <span class="type secondary">[[_returnSerial(index)]]. </span>
                <span>{{item.name}}</span>
                <template is="dom-if" if="[[_compareFn(item.possibleValueList.length, '>', 0)]]">
                  (
                  <template is="dom-repeat" items="[[item.possibleValueList]]">
                    <span>{{item}}, </span>
                  </template>)
                </template>
              </div>
            </template>
            <div class="b-top m-top-8"></div>
          </template>
          <!-- Print - Diagnosis - end -->

          <!-- Print Referral Start -->

          <div class="layout horizontal">
            <span class="type bold">Referred By: </span> [[referral.data.referredByDoctorName]]
          </div>
          <template is="dom-if" if="[[referral.data.doctorName]]">
            <div class="layout horizontal">
              <span class="type bold">Referred To: </span> [[referral.data.doctorName]]
            </div>
            <div class="layout horizontal">
              <span class="type bold">Speciality: </span> [[referral.data.speciality]]</div>
          </template>
          <template is="dom-if" if="[[referral.data.organizationName]]">
            <div class="layout horizontal">
              <span class="type bold">Organization Name: </span> [[referral.data.organizationName]]</div>
          </template>
          <!-- Print Referral end -->

          <!-- Print - Notes - start -->
          <template is="dom-if" if="{{!_isEmpty(doctorNotes.data.messageList.length)}}">
            <div class="horizontal layout center print-sub-header">
              <div class="type body">Doctor Advised/Notes</div>
            </div>
            <ul class="unorderd-list-custom">
              <template is="dom-repeat" items="[[doctorNotes.data.messageList]]">
                <li class="type caption-2" style="word-break: break-word; margin-right: 4px;">{{item}}</li>
              </template>
            </ul>
            <div class="b-top m-top-8"></div>
          </template>
          <!-- Print - Notes - end -->

          <!-- Print - Next Visit - start -->
          <template is="dom-if" if="[[!_isEmptyString(nextVisit.data.nextVisitDateTimestamp)]]">
            <div class="horizontal layout center print-sub-header">
              <div class="type body">Next Visit</div>
            </div>
            <div class="type caption-2">
              <div>
                <strong>Date: </strong>
                <span>[[$mkDate(nextVisit.data.nextVisitDateTimestamp)]]</span>
              </div>
              <div>{{nextVisit.data.priorityType}}</div>
            </div>
            <div class="b-top m-top-8"></div>
          </template>
          <!-- Print - Next Visit - end -->
        </div>
        <!-- Print Content - Left - end -->

        <!-- Print Content - right - start -->
        <div class="right">

          <!-- Print - History And Physical - start -->
          <template is="dom-if" if="[[shouldRender]]">
            <div class="horizontal layout center">
              <div class="type body print-sub-header">[[recordPartTitle]]</div>
            </div>
            <div class="p-horizontal-16">
              <html-block html="[[recordPartHtmlContent]]"></html-block>
            </div>
            <div class="b-top m-top-8"></div>
          </template>
          <!-- Print - History And Physical - end -->

          <br>
          <br>

          <!-- Print - Prescription - start -->
          <template is="dom-if" if="[[!_isEmpty(matchingPrescribedMedicineList.length)]]">
            <div class="horizontal layout center print-sub-header">
              <div class="type body p-left-16">Prescription</div>
            </div>

            <template is="dom-repeat" items="[[matchingPrescribedMedicineList]]">
              <div class="m-vertical-8 p-left-16 horizontal layout center">
                <div class="type caption secondary m-right-8">[[_returnSerial(index)]].</div>
                <div>
                  <div>
                    <span class="type caption-2 text-bold">{{item.data.brandName}}</span>
                    <span class="type caption bg-gray">[[item.data.manufacturer]]</span>
                    <span class="type caption italic">{{item.data.genericName}} {{item.data.strength}}</span>
                  </div>


                  <div class="type caption">
                    <strong>Instruction: </strong>
                    <span>[[$TRANSLATE_NUMBER(item.data.doseDirection, LANG)]] [[$TRANSLATE('for', LANG)]] [[_computeTotalDaysCount(item.data.endDateTimeStamp,item.data.startDateTimeStamp)]]
                      <span hidden$="[[!item.data.endDateTimeStamp]]">[[$TRANSLATE('Days',LANG)]]</span>
                    </span>
                    <span>[[$TRANSLATE('By', LANG)]] </span>
                    <span>[[$TRANSLATE(item.data.route, LANG)]]</span>
                    <span>[[$TRANSLATE(item.data.direction, LANG)]] </span>
                  </div>
                  <div class="type caption">[[item.data.comments]]</div>
                </div>
              </div>
            </template>

          </template>
          <!-- Print - Prescription - end -->
          <br>
          <!-- Patient Stay Preview -->
          <template is="dom-if" if="[[patientStay.serial]]">
            <div class="horizontal layout center print-sub-header">
              <div class="type body p-left-16">Patient Stay</div>
            </div>
            <div class="p-horizontal-16">
              <div class="layout horizontal">
                <span class="type bold"> Admission Date: </span>
                <span>&nbsp;[[$mkDate(patientStay.data.admissionDateTimeStamp)]]</span>
              </div>
              <div>
                <span class="type bold">Type: </span> [[patientStay.data.admissionType]]
              </div>
              <template is="dom-if" if="[[patientStay.adviseOnly]]">
                <div>
                  <span class="type bold">Advice: </span> [[patientStay.data.advise]]
                </div>
              </template>
              <template is="dom-if" if="[[!patientStay.adviseOnly]]">
                <div>
                  <span class="type bold">Referred By: </span> [[patientStay.data.referredByDoctorName]]
                </div>
                <div>
                  <span class="type bold">Admitted By: </span> [[patientStay.data.admittedByDoctorName]]
                </div>
                <div class="type italic">
                  <span>[[patientStay.data.locationHospitalName]]</span> >
                  <span>[[patientStay.data.locationDepartment]]</span> >
                  <span>[[patientStay.data.locationUnit]]</span> >
                  <span>[[patientStay.data.locationWard]]</span> >
                  <span>[[patientStay.data.locationBed]]</span>
                </div>
              </template>
              <template is="dom-if" if="[[patientStay.data.currentLocation.length]]">
                <div>
                  <span class="type bold"> Current Location:</span>
                  <span>[[patientStay.data.currentLocation.0.location]]</span>
                </div>
              </template>
              <template is="dom-if" if="[[patientStay.data.dischargeDatetimeStamp]]">
                <div>
                  <span class="type bold"> Discharge Date:</span>
                  <span>[[$mkDate(patientStay.data.dischargeDatetimeStamp)]]</span>
                </div>
                <div>
                  <span class="type bold">Discharged By: </span> [[patientStay.data.dischargedByDoctorName]]
                </div>
                <div>
                  <span class="type bold"> Length of Stay:</span>
                  <span>[[calculateLengthOfStay(patientStay.data.admissionDateTimeStamp, patientStay.data.dischargeDatetimeStamp)]]
                    Days
                  </span>
                </div>
              </template>
              <template is="dom-if" if="[[patientStay.data.dischargeReason.length]]">
                <div>
                  <span class="type bold">Discharge Reason: </span> [[patientStay.data.dischargeReason]]</div>
              </template>
              <template is="dom-if" if="[[patientStay.data.dischargeTo.length]]">
                <div>
                  <span class="type bold"> Discharged To:</span> [[patientStay.data.dischargeTo]]</div>
              </template>
            </div>
          </template>
          <!-- Patient Stay Preview End -->
        </div>
        <!-- Print Content - right - end -->
      </div>
      <!-- Print Content [FULL] - end -->

      <!-- Print Content - [Prescripton only] - start -->
      <div hidden$="{{!printPrescriptionOnly}}">
        <template is="dom-if" if="[[!_isEmpty(matchingPrescribedMedicineList.length)]]">
          <div class="horizontal layout center print-sub-header">
            <div class="type body p-left-16">Prescription</div>
          </div>

          <template is="dom-repeat" items="[[matchingPrescribedMedicineList]]">
            <div class="m-vertical-8 p-left-16 horizontal layout center">
              <div class="type caption secondary m-right-8">[[_returnSerial(index)]].</div>
              <div>
                <div>
                  <span class="type caption-2 text-bold">{{item.data.brandName}}</span>
                  <span class="type caption bg-gray">[[item.data.manufacturer]]</span>
                  <span class="type caption italic">{{item.data.genericName}} {{item.data.strength}}</span>
                </div>


                <div class="type caption">
                  <strong>Instruction: </strong>
                  <span>[[$TRANSLATE_NUMBER(item.data.doseDirection, LANG)]] [[$TRANSLATE('for', LANG)]] [[_computeTotalDaysCount(item.data.endDateTimeStamp,item.data.startDateTimeStamp)]]
                    <span hidden$="[[!item.data.endDateTimeStamp]]">[[$TRANSLATE('Days',LANG)]]</span>
                  </span>
                  <span>[[$TRANSLATE('By', LANG)]] </span>
                  <span>[[$TRANSLATE(item.data.route, LANG)]]</span>
                  <span>[[$TRANSLATE(item.data.direction, LANG)]] </span>
                </div>
                <div class="type caption">[[item.data.comments]]</div>
              </div>
            </div>
          </template>
        </template>
      </div>
      <!-- Print Content - [Prescripton only] - end -->

      <div>
        <div class="horizontal layout end-justified center">
          <template is="dom-if" if="[[settings.printDecoration.signatureDataUri]]">
            <img height="96" width="128" class="logo" src="[[settings.printDecoration.signatureDataUri]]" alt="signature">
          </template>
        </div>
        <div class="type caption secondary" style="text-align: center; padding: 8px;">
          <div>
            <i>
              <strong>prepared by: </strong>{{user.name}}</i>
          </div>

        </div>
        <template is="dom-if" if="[[settings.flags.showFooterLine]]">
          <div class="b-top">
            <div class="type caption secondary">[[settings.printDecoration.footerLine]]</div>
          </div>
        </template>
      </div>

    </div>

  </template>
  <script src="mixin-utils.js"></script>
  <script>
    Polymer({
      is: 'element-print-preview',
      behaviors: [
        app.behaviors.commonComputes,
        app.behaviors.dbUsing,
        app.behaviors.translating,
        app.behaviors.apiCalling,
        app.behaviors.local.visitUtilsMixin
      ],
      properties: {
        patient: {
          type: Object,
          observer: 'patientValueChanged'
        },
        user: {
          type: Object
        },
        visit: {
          type: Object,
          observer: 'visitValueChanged'
        },
        organization: {
          type: Object
        },
      },

      attached: function () {

      },

      detached: function () {

      }
    });
  </script>
</dom-module>