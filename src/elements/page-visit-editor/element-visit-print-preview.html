<link rel="import" href="../../behaviors/common-computes.html">
<link rel="import" href="../../behaviors/db-using.html">
<link rel="import" href="../../behaviors/translating.html">
<link rel="import" href="../../behaviors/api-calling.html">

<link rel="import" href="../../bower-assets/paper-button/paper-button.html">
<link rel="import" href="../../bower-assets/paper-card/paper-card.html">
<link rel="import" href="../../bower-assets/paper-input/paper-input.html">
<link rel="import" href="../../bower-assets/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower-assets/paper-menu/paper-menu.html">
<link rel="import" href="../../bower-assets/paper-item/paper-item.html">
<link rel="import" href="../../bower-assets/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower-assets/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower-assets/paper-icon-button/paper-icon-button.html">
<!-- custom-elements -->
<link rel="import" href="../html-block/html-block.html">

<link rel="import" href="../../styles/common-style.html">
<link rel="import" href="visit-common-styles.html">

<dom-module id="element-print-preview">
  <template>
    <style is="custom-style" include="common-style visit-common-styles">
    </style>


    <div id="printPreview">

      <div class="print-header horizontal layout center center-justified">
        <h1>[[settings.printDecoration.headerLine]]</h1>
      </div>

      <!-- Print Header - Main - start -->
      <div class="document-header horizontal layout center">
        <template is="dom-if" if="[[settings.printDecoration.logoDataUri]]">
          <img class="logo" src="[[settings.printDecoration.logoDataUri]]" alt="">
        </template>

        <div class="leftSide">
          <div class="leftSideLine1">[[settings.printDecoration.leftSideLine1]]</div>
          <div class="leftSideLine2">[[settings.printDecoration.leftSideLine2]]</div>
          <div class="leftSideLine3">[[settings.printDecoration.leftSideLine3]]</div>
        </div>
        <div class="flex"></div>
        <div class="rightSide layout end-justified">
          <div class="rightSideLine1">[[settings.printDecoration.rightSideLine1]]</div>
          <div class="rightSideLine2">[[settings.printDecoration.rightSideLine2]]</div>
          <div class="rightSideLine3">[[settings.printDecoration.rightSideLine3]]</div>
        </div>
      </div>
      <!-- Print Header - Main - end -->

      <!-- Print Header - Patient Details - start -->
      <div class="document-header horizontal layout center p-vertical-8">
        <template is="dom-if" if="[[!patient.isForOrganizationOnly]]">
          <div class="m-horizontal-4">
            <strong>Patient Serial: </strong>
            <span>{{patient.serial}}</span>
          </div>
          <div class="m-horizontal-4">
            <strong>Patient Name: </strong>
            <span>{{patient.name}}</span>
          </div>
          <div class="m-horizontal-4">
            <strong>Sex: </strong>
            <span></span>
          </div>
          <div class="m-horizontal-4">
            <strong>Age: </strong>
            <span>[[_computeAge(patient.dob)]] years </span>
          </div>
          <div class="m-horizontal-4">
            <strong>Blood Group: [[patient.bloodGroup]] </strong>
            <span> </span>
          </div>
          <div class="m-horizontal-4">
            <strong>Allergy: [[patient.allergy]]</strong>
            <span> </span>
          </div>
        </template>

        <template is="dom-if" if="[[patient.isForOrganizationOnly]]">
          <div class="m-horizontal-4">
            <strong>Patient Name: </strong>
            <i></i>
          </div>
          <div class="m-horizontal-4">
            <strong>Age: </strong>
            <i>REDACTED FOR CONFIDENTIALITY</i>
          </div>
          <div class="m-horizontal-4">
            <strong>Blood Group: [[patient.bloodGroup]]</strong>
            <span> </span>
          </div>
          <div class="m-horizontal-4">
            <strong>Allergy: [[patient.allergy]]</strong>
            <span> </span>
          </div>
        </template>
      </div>
      <!-- Print Header - Patient Details - end -->

      <!-- Print Header - record Title - start -->
      <div class="p-16 horizontal layout center center-justified" hidden$="{{!printPrescriptionOnly}}">
        <div class="type headline">{{visit.recordTitle}}</div>
      </div>
      <!-- Print Header - record Title - start -->

      <!-- Print Content [FULL] - start -->
      <div class="print-content" hidden$="{{printPrescriptionOnly}}">
        <!-- Print Content - Left - start -->
        <div class="left">

          <!-- Print - Symptoms - start -->
          <template is="dom-if" if="[[!_isEmpty(addedIdentifiedSymptomsList.length)]]">
            <div class="horizontal layout center print-sub-header">
              <div class="type body">Symptoms</div>
            </div>
            <template is="dom-repeat" items="[[addedIdentifiedSymptomsList]]">
              <div class="type caption-2">
                <span class="type secondary">[[_returnSerial(index)]]. </span>
                <span>{{item.name}}</span>
                <template is="dom-if" if="[[_compareFn(item.possibleValueList.length, '>', 0)]]">
                  (
                  <template is="dom-repeat" items="[[item.possibleValueList]]">
                    <span>{{item}}, </span>
                  </template>)
                </template>
              </div>
            </template>
            <div class="b-top m-top-8"></div>
          </template>
          <!-- Print - Symptoms - end -->

          <!-- Print - Examination - start -->
          <template is="dom-if" if="[[!_isEmpty(addedExaminationList2.length)]]">
            <div class="horizontal layout center print-sub-header">
              <div class="type body">Examination</div>
            </div>
            <template is="dom-repeat" items="[[addedExaminationList2]]" as="examination">
              <div class="type caption-2">
                <span class="type secondary">[[_returnSerial(index)]]. </span>
                <span>{{examination.name}}</span>
                (
                <template is="dom-repeat" items="[[examination.examinationValueList]]" as="examItem">
                  <span hidden$="{{!examItem.checked}}">{{examItem.value}}, </span>
                </template>)
              </div>
            </template>
            <div class="b-top m-top-8 "></div>
          </template>
          <!-- Print - Examination - end -->

          <!-- Print - Vitals - start -->
          <template is="dom-if" if="[[!_isEmpty(addedVitalList.length)]]">
            <div class="horizontal layout center print-sub-header">
              <div class="type body">Vitals</div>
            </div>
            <template is="dom-repeat" items="[[addedVitalList]]">
              <div class="type caption-2">
                <strong>{{item.vitalType}}: </strong>
                <span>[[_pritifyVitalData(item)]]</span>
              </div>
            </template>
            <div class="b-top m-top-8"></div>
          </template>
          <!-- Print - Vitals - end -->

          <!-- Print - Test Advised - start -->
          <template is="dom-if" if="[[!_isEmpty(addedInvestigationList.length)]]">
            <div class="horizontal layout center print-sub-header">
              <div class="type body">Advised Test</div>
            </div>
            <template is="dom-repeat" items="[[addedInvestigationList]]">
              <div class="type caption-2 layout horizontal">
                <div class="type secondary m-right-8">[[_returnSerial(index)]]. </div>
                <div class="flex vertical layout">
                  <div>{{item.investigationName}}</div>
                  <template is="dom-if" if="[[_compareFn(item.testList.length, '==', 1)]]">
                    <ol class="order-list">
                      <li>{{item.testList.0.name}}</li>
                    </ol>
                  </template>
                  <template is="dom-if" if="[[_compareFn(item.testList.length, '>', 1)]]">
                    <ol class="order-list">
                      <template is="dom-repeat" items="[[item.testList]]">
                        <li>{{item.name}}</li>
                      </template>
                    </ol>
                  </template>
                </div>
                <template is="dom-if" if="[[item.suggestedInstitutionName]]">
                  <div class="type caption secondary m-left-16">
                    <strong>Suggested Institution: </strong>
                    <span class="flex">{{item.suggestedInstitutionName}}</span>
                  </div>
                </template>
              </div>
            </template>
            <div class="b-top"></div>
          </template>
          <!-- Print - Test Advised - end -->

          <!-- Print - Diagnosis - start -->
          <template is="dom-if" if="{{!_isEmpty(diagnosis.data.diagnosisList.length)}}">
            <div class="horizontal layout center print-sub-header">
              <div class="type body">Diagnosis</div>
            </div>
            <template is="dom-repeat" items="[[diagnosis.data.diagnosisList]]">
              <div class="type caption-2">
                <span class="type secondary">[[_returnSerial(index)]]. </span>
                <span>{{item.name}}</span>
                <template is="dom-if" if="[[_compareFn(item.possibleValueList.length, '>', 0)]]">
                  (
                  <template is="dom-repeat" items="[[item.possibleValueList]]">
                    <span>{{item}}, </span>
                  </template>)
                </template>
              </div>
            </template>
            <div class="b-top m-top-8"></div>
          </template>
          <!-- Print - Diagnosis - end -->

          <!-- Print Referral Start -->

          <div class="layout horizontal">
            <span class="type bold">Referred By: </span> [[referral.data.referredByDoctorName]]
          </div>
          <template is="dom-if" if="[[referral.data.doctorName]]">
            <div class="layout horizontal">
              <span class="type bold">Referred To: </span> [[referral.data.doctorName]]
            </div>
            <div class="layout horizontal">
              <span class="type bold">Speciality: </span> [[referral.data.speciality]]</div>
          </template>
          <template is="dom-if" if="[[referral.data.organizationName]]">
            <div class="layout horizontal">
              <span class="type bold">Organization Name: </span> [[referral.data.organizationName]]</div>
          </template>
          <!-- Print Referral end -->

          <!-- Print - Notes - start -->
          <template is="dom-if" if="{{!_isEmpty(doctorNotes.data.messageList.length)}}">
            <div class="horizontal layout center print-sub-header">
              <div class="type body">Doctor Advised/Notes</div>
            </div>
            <ul class="unorderd-list-custom">
              <template is="dom-repeat" items="[[doctorNotes.data.messageList]]">
                <li class="type caption-2" style="word-break: break-word; margin-right: 4px;">{{item}}</li>
              </template>
            </ul>
            <div class="b-top m-top-8"></div>
          </template>
          <!-- Print - Notes - end -->

          <!-- Print - Next Visit - start -->
          <template is="dom-if" if="[[!_isEmptyString(nextVisit.data.nextVisitDateTimestamp)]]">
            <div class="horizontal layout center print-sub-header">
              <div class="type body">Next Visit</div>
            </div>
            <div class="type caption-2">
              <div>
                <strong>Date: </strong>
                <span>[[$mkDate(nextVisit.data.nextVisitDateTimestamp)]]</span>
              </div>
              <div>{{nextVisit.data.priorityType}}</div>
            </div>
            <div class="b-top m-top-8"></div>
          </template>
          <!-- Print - Next Visit - end -->
        </div>
        <!-- Print Content - Left - end -->

        <!-- Print Content - right - start -->
        <div class="right">

          <!-- Print - History And Physical - start -->
          <template is="dom-if" if="[[shouldRender]]">
            <div class="horizontal layout center">
              <div class="type body print-sub-header">[[recordPartTitle]]</div>
            </div>
            <div class="p-horizontal-16">
              <html-block html="[[recordPartHtmlContent]]"></html-block>
            </div>
            <div class="b-top m-top-8"></div>
          </template>
          <!-- Print - History And Physical - end -->

          <br>
          <br>

          <!-- Print - Prescription - start -->
          <template is="dom-if" if="[[!_isEmpty(matchingPrescribedMedicineList.length)]]">
            <div class="horizontal layout center print-sub-header">
              <div class="type body p-left-16">Prescription</div>
            </div>

            <template is="dom-repeat" items="[[matchingPrescribedMedicineList]]">
              <div class="m-vertical-8 p-left-16 horizontal layout center">
                <div class="type caption secondary m-right-8">[[_returnSerial(index)]].</div>
                <div>
                  <div>
                    <span class="type caption-2 text-bold">{{item.data.brandName}}</span>
                    <span class="type caption bg-gray">[[item.data.manufacturer]]</span>
                    <span class="type caption italic">{{item.data.genericName}} {{item.data.strength}}</span>
                  </div>


                  <div class="type caption">
                    <strong>Instruction: </strong>
                    <span>[[$TRANSLATE_NUMBER(item.data.doseDirection, LANG)]] [[$TRANSLATE('for', LANG)]] [[_computeTotalDaysCount(item.data.endDateTimeStamp,item.data.startDateTimeStamp)]]
                      <span hidden$="[[!item.data.endDateTimeStamp]]">[[$TRANSLATE('Days',LANG)]]</span>
                    </span>
                    <span>[[$TRANSLATE('By', LANG)]] </span>
                    <span>[[$TRANSLATE(item.data.route, LANG)]]</span>
                    <span>[[$TRANSLATE(item.data.direction, LANG)]] </span>
                  </div>
                  <div class="type caption">[[item.data.comments]]</div>
                </div>
              </div>
            </template>

          </template>
          <!-- Print - Prescription - end -->
          <br>
          <!-- Patient Stay Preview -->
          <template is="dom-if" if="[[patientStay.serial]]">
            <div class="horizontal layout center print-sub-header">
              <div class="type body p-left-16">Patient Stay</div>
            </div>
            <div class="p-horizontal-16">
              <div class="layout horizontal">
                <span class="type bold"> Admission Date: </span>
                <span>&nbsp;[[$mkDate(patientStay.data.admissionDateTimeStamp)]]</span>
              </div>
              <div>
                <span class="type bold">Type: </span> [[patientStay.data.admissionType]]
              </div>
              <template is="dom-if" if="[[patientStay.adviseOnly]]">
                <div>
                  <span class="type bold">Advice: </span> [[patientStay.data.advise]]
                </div>
              </template>
              <template is="dom-if" if="[[!patientStay.adviseOnly]]">
                <div>
                  <span class="type bold">Referred By: </span> [[patientStay.data.referredByDoctorName]]
                </div>
                <div>
                  <span class="type bold">Admitted By: </span> [[patientStay.data.admittedByDoctorName]]
                </div>
                <div class="type italic">
                  <span>[[patientStay.data.locationHospitalName]]</span> >
                  <span>[[patientStay.data.locationDepartment]]</span> >
                  <span>[[patientStay.data.locationUnit]]</span> >
                  <span>[[patientStay.data.locationWard]]</span> >
                  <span>[[patientStay.data.locationBed]]</span>
                </div>
              </template>
              <template is="dom-if" if="[[patientStay.data.currentLocation.length]]">
                <div>
                  <span class="type bold"> Current Location:</span>
                  <span>[[patientStay.data.currentLocation.0.location]]</span>
                </div>
              </template>
              <template is="dom-if" if="[[patientStay.data.dischargeDatetimeStamp]]">
                <div>
                  <span class="type bold"> Discharge Date:</span>
                  <span>[[$mkDate(patientStay.data.dischargeDatetimeStamp)]]</span>
                </div>
                <div>
                  <span class="type bold">Discharged By: </span> [[patientStay.data.dischargedByDoctorName]]
                </div>
                <div>
                  <span class="type bold"> Length of Stay:</span>
                  <span>[[calculateLengthOfStay(patientStay.data.admissionDateTimeStamp, patientStay.data.dischargeDatetimeStamp)]]
                    Days
                  </span>
                </div>
              </template>
              <template is="dom-if" if="[[patientStay.data.dischargeReason.length]]">
                <div>
                  <span class="type bold">Discharge Reason: </span> [[patientStay.data.dischargeReason]]</div>
              </template>
              <template is="dom-if" if="[[patientStay.data.dischargeTo.length]]">
                <div>
                  <span class="type bold"> Discharged To:</span> [[patientStay.data.dischargeTo]]</div>
              </template>
            </div>
          </template>
          <!-- Patient Stay Preview End -->
        </div>
        <!-- Print Content - right - end -->
      </div>
      <!-- Print Content [FULL] - end -->

      <!-- Print Content - [Prescripton only] - start -->
      <div hidden$="{{!printPrescriptionOnly}}">
        <template is="dom-if" if="[[!_isEmpty(matchingPrescribedMedicineList.length)]]">
          <div class="horizontal layout center print-sub-header">
            <div class="type body p-left-16">Prescription</div>
          </div>

          <template is="dom-repeat" items="[[matchingPrescribedMedicineList]]">
            <div class="m-vertical-8 p-left-16 horizontal layout center">
              <div class="type caption secondary m-right-8">[[_returnSerial(index)]].</div>
              <div>
                <div>
                  <span class="type caption-2 text-bold">{{item.data.brandName}}</span>
                  <span class="type caption bg-gray">[[item.data.manufacturer]]</span>
                  <span class="type caption italic">{{item.data.genericName}} {{item.data.strength}}</span>
                </div>


                <div class="type caption">
                  <strong>Instruction: </strong>
                  <span>[[$TRANSLATE_NUMBER(item.data.doseDirection, LANG)]] [[$TRANSLATE('for', LANG)]] [[_computeTotalDaysCount(item.data.endDateTimeStamp,item.data.startDateTimeStamp)]]
                    <span hidden$="[[!item.data.endDateTimeStamp]]">[[$TRANSLATE('Days',LANG)]]</span>
                  </span>
                  <span>[[$TRANSLATE('By', LANG)]] </span>
                  <span>[[$TRANSLATE(item.data.route, LANG)]]</span>
                  <span>[[$TRANSLATE(item.data.direction, LANG)]] </span>
                </div>
                <div class="type caption">[[item.data.comments]]</div>
              </div>
            </div>
          </template>
        </template>
      </div>
      <!-- Print Content - [Prescripton only] - end -->

      <div>
        <div class="horizontal layout end-justified center">
          <template is="dom-if" if="[[settings.printDecoration.signatureDataUri]]">
            <img height="96" width="128" class="logo" src="[[settings.printDecoration.signatureDataUri]]" alt="signature">
          </template>
        </div>
        <div class="type caption secondary" style="text-align: center; padding: 8px;">
          <div>
            <i>
              <strong>prepared by: </strong>{{user.name}}</i>
          </div>

        </div>
        <template is="dom-if" if="[[settings.flags.showFooterLine]]">
          <div class="b-top">
            <div class="type caption secondary">[[settings.printDecoration.footerLine]]</div>
          </div>
        </template>
      </div>

    </div>

  </template>
  <script src="mixin-utils.js"></script>
  <script>
    Polymer({
      is: 'element-print-preview',
      behaviors: [
        app.behaviors.commonComputes,
        app.behaviors.dbUsing,
        app.behaviors.translating,
        app.behaviors.apiCalling,
        app.behaviors.local.visitUtilsMixin
      ],
      properties: {
        patient: Object,
        user: Object,
        visit: {
          type: Object,
          observer: 'visitValueChanged'
        },
        organization: {
          type: Object
        },
      },

      attached: function () {

      },

      detached: function () {

      },

      visitValueChanged: function (visit) {

        if (!visit) return;
        if (!visit.serial) {
        }
        if (visit.serial) {

        }
      },

      //####################################################################
      // Full Visit Preview - start
      //####################################################################

      _headerTitleListIndexChanged() {
        if (this.visit.serial) {
          this.visit.recordTitle = '';
          this.set('visit.recordTitle', this.visitHeaderTitleList[this.visitHeaderTitleSelectedIndex]);
          return this.domHost._saveVisit();
        }
      },
      //# Settings - start

      _makeSettings() {
        return this.settings = {
          createdByUserSerial: this.user.serial,
          lastModifiedDatetimeStamp: 0,
          createdDatetimeStamp: lib.datetime.now(),
          lastSyncedDatetimeStamp: null,
          serial: this.user.serial,
          printDecoration: {
            leftSideLine1: 'My Institution',
            leftSideLine2: 'My Institution Address',
            leftSideLine3: 'My Institution Contact',
            rightSideLine1: 'My Name',
            rightSideLine2: 'My Degrees',
            rightSideLine3: 'My Contact',
            footerLine: 'A simple message on the bottom',
            logoDataUri: null
          },
          billingTargetEmailAddress: '',
          nsqipTargetEmailAddress: '',
          monetaryUnit: 'BDT',
          otherSettings: {
            patientSignUpDefaultPassword: '123456'
          }
        };
      },

      _getSettings() {
        let settings;
        const list = app.db.find('settings');
        if (list.length === 0) {
          settings = this._makeSettings();
        } else {
          settings = list[0];
        }
        // console.log settings
        return settings;
      },

      //# Settings - end

      //# VIEW :: HistoryAndPhysical - start
      _getRecord(recordIdentifier, desiredRecordType) {
        const list = app.db.find(desiredRecordType, ({ serial }) => serial === recordIdentifier);
        if (list.length === 1) {
          return list[0];
        } else {
          return null;
        }
      },

      //# NOTE - PRINT ======================================================================================
      // The code below is unavoidably messy looking due to the various requirements in the data 
      // definition. If the namespace is not polluted then we will not have any serious consequences
      // when it comes to performance.

      generateHtmlContent(def, data) {
        let html = this.handle_type(def, data.data);
        html = this.filterHtmlContent(html);
        return html;
      },

      filterHtmlContent(html) {
        html = html.replace(/@VALUE@/g, '');
        return html;
      },

      printOutStyleSheet() {
        return `\
        <style>
          
            .default-category {
              /* font-size: 20px; 
              font-weight: bold; */
              text-align: center; 
            }
            .default-collection {
              /* font-size: 16px; 
              font-weight: bold; */
            }
            .default-group {
              /* text-decoration: overline; */
            }
            .default-card {
              /* text-decoration: underline; */
            }
            span {
              font-size: 14px;
            }
            .unprocessed {
              color: red;
            }
        </style>\
        `;
      },

      handle_children(def, data) {
        let html = '';
        // console.log data
        if ('childMap' in data && 'childList' in def && (def.childList !== null)) {
          for (let childIndex = 0; childIndex < def.childList.length; childIndex++) {
            const child = def.childList[childIndex];
            if (child.key in data.childMap) {
              let childHtml = this.handle_type(child, data.childMap[child.key]);
              if (childHtml && !([';', ':;', ': ;'].includes(childHtml))) {
                childHtml = this.sanitizeOutput(childHtml);
                html += childHtml;
              }
            }
          }
        } else {
          console.log('end-case');
        }
        return html;
      },

      handle_type(def, data) {
        // console.log def.key, @listPrintDirectives def
        if (!('print' in def)) { def.print = {}; }
        if (def.type === 'systemRoot') {
          this.flattenStyle(def);
          return this.type_systemRoot(def, data);
        } else if (def.type === 'category') {
          if (!('boldLabel' in def.print)) { def.print.boldLabel = true; }
          if (!('fontSize' in def.print)) { def.print.fontSize = 18; }
          this.flattenStyle(def);
          return this.type_category(def, data);
        } else if (def.type === 'collection') {
          if (!('boldLabel' in def.print)) { def.print.boldLabel = true; }
          if (!('fontSize' in def.print)) { def.print.fontSize = 16; }
          this.flattenStyle(def);
          return this.type_collection(def, data);
        } else if (def.type === 'group') {
          if (!('passThrough' in def.print)) { def.print.passThrough = true; }
          if (!('fontSize' in def.print)) { def.print.fontSize = 14; }
          this.flattenStyle(def);
          return this.type_group(def, data);
        } else if (def.type === 'card') {
          if (!('boldLabel' in def.print)) { def.print.boldLabel = true; }
          if (!('fontSize' in def.print)) { def.print.fontSize = 14; }
          this.flattenStyle(def);
          return this.type_card(def, data);
        } else if (def.type === 'checkbox') {
          this.flattenStyle(def);
          return this.type_checkbox(def, data);
        } else if (def.type === 'toggleableContainer') {
          this.flattenStyle(def);
          return this.type_toggleableContainer(def, data);
        } else if (def.type === 'label') {
          this.flattenStyle(def);
          return this.type_label(def, data);
        } else if (def.type === 'autocomplete') {
          if ('selectionType' in def && (def.selectionType === 'label')) {
            if (!('separatorString' in def.print)) { def.print.separatorString = ", "; }
          }
          this.flattenStyle(def);
          return this.type_autocomplete(def, data);
        } else if (def.type === 'container') {
          this.flattenStyle(def);
          return this.type_container(def, data);
        } else if (def.type === 'checkList') {
          if (!('separatorString' in def.print)) { def.print.separatorString = ", "; }
          this.flattenStyle(def);
          return this.type_checkList(def, data);
        } else if (def.type === 'radioList') {
          if (!('separatorString' in def.print)) { def.print.separatorString = ", "; }
          this.flattenStyle(def);
          return this.type_radioList(def, data);
        } else if (def.type === 'input') {
          this.flattenStyle(def);
          return this.type_input(def, data);
        } else if (def.type === 'singleSelectDropdown') {
          this.flattenStyle(def);
          return this.type_singleSelectDropdown(def, data);
        } else if (def.type === 'incrementalCounter') {
          this.flattenStyle(def);
          return this.type_incrementalCounter(def, data);
        } else {
          return `<span class="unprocessed">UNPROCESSED ${def.type} - ${def.key}</span>`;
        }
      },


      flattenStyle(def) {
        if ('passThrough' in def.print) {
          if (!('hideLabel' in def.print)) {
            def.print.hideLabel = true;
          }
          if (!('noColonAfterThis' in def.print)) {
            def.print.noColonAfterThis = true;
          }
          if (!('noSemicolonAfterThis' in def.print)) {
            def.print.noSemicolonAfterThis = false;
          }
        }
        // delete def.print['passThrough']
        if ('newLineBeforeThis' in def.print) {
          if (typeof def.print.newLineBeforeThis === 'boolean') {
            def.print.newLineBeforeThis = (def.print.newLineBeforeThis === true ? 1 : 0);
          } else {
            def.print.newLineBeforeThis = parseInt(def.print.newLineBeforeThis);
          }
        }
        if ('newLineAfterThis' in def.print) {
          if (typeof def.print.newLineAfterThis === 'boolean') {
            def.print.newLineAfterThis = (def.print.newLineAfterThis === true ? 1 : 0);
          } else {
            def.print.newLineAfterThis = parseInt(def.print.newLineAfterThis);
          }
        }
        if ('newLineAfterThisAndChildren' in def.print) {
          if (typeof def.print.newLineAfterThisAndChildren === 'boolean') {
            def.print.newLineAfterThisAndChildren = (def.print.newLineAfterThisAndChildren === true ? 1 : 0);
          } else {
            def.print.newLineAfterThisAndChildren = parseInt(def.print.newLineAfterThisAndChildren);
          }
        }
        if ('newLineAfterEachValue' in def.print) {
          if (typeof def.print.newLineAfterEachValue === 'boolean') {
            return def.print.newLineAfterEachValue = (def.print.newLineAfterEachValue === true ? 1 : 0);
          } else {
            return def.print.newLineAfterEachValue = parseInt(def.print.newLineAfterEachValue);
          }
        }
      },

      sanitizeOutput(content) {
        for (let i = 0; i <= 2; i++) {
          content = content.replace(/\;;/g, ';');
          content = content.replace(/\;;/g, ';');
          content = content.replace(/\; ;/g, ';');
          content = content.replace(/\: ;/g, ';');
          content = content.replace(/\: :/g, ':');
          content = content.replace(/\, ;/g, ';');
          content = content.replace(/\; ,/g, ';');
          content = content.replace(/\,;/g, ';');

          content = content.replace(/<\/span style=""><\/span>/g, '');
          content = content.replace(/<\/span>;<\/span>/g, '<\/span><\/span>');
          content = content.replace(/<\/span>; <\/span>/g, '<\/span><\/span>');
          content = content.replace(/<\/span> ,<\/span>/g, '<\/span><\/span>');
        }

        return content;
      },


      /*
        REGION - VARIOUS TYPES
      */

      _computeElementStyle(def) {
        let style = '';
        if (def.print.fontSize) {
          style += `font-size: ${def.print.fontSize}px;`;
        }
        if (def.print.hide) {
          style += "display: none;";
        }
        return style;
      },

      _computeTitleOrLabelStyle(def) {
        let style = '';
        if (def.print.boldLabel) {
          style += "font-weight: bold;";
        }
        return style;
      },

      type_systemRoot(def, data) {
        const content = (this.handle_children(def, data));
        return this.printOutStyleSheet() + content;
      },

      type_category(def, data) {
        const content = this.handle_children(def, data);
        if (content.length === 0) { return ''; }
        let style = this._computeTitleOrLabelStyle(def);
        const title = `<span style="${style}">${def.label}</span>`;
        style = this._computeElementStyle(def);
        const html = `<div class="default-category" style="${style}">${title}</div>${content}`;
        return html;
      },

      type_collection(def, data) {
        let content;
        if ((Object.keys(data.childMap)).length === 0) { return ''; }
        if (def.defaultGroup && !data.isDefaultGroupDismissed) {
          content = this.handle_type(def.defaultGroup, data.childMap[def.defaultGroup.key]);
        } else {
          content = this.handle_children(def, data);
        }
        let style = this._computeTitleOrLabelStyle(def);
        const title = `<br><span style="${style}">${def.label}</span><br>`;
        style = this._computeElementStyle(def);
        const html = `<span class="default-collection" style="${style}">${title}</span>: ${content}<br>`;
        return html;
      },

      type_group(def, data) {
        let html;
        const content = this.handle_children(def, data);
        let style = this._computeTitleOrLabelStyle(def);
        const title = `<span style="${style}">${def.label}</span>`;
        if (def.print.passThrough) {
          html = `${content};`;
        } else {
          style = this._computeElementStyle(def);
          html = `<span class="default-group" style="${style}">${title}</span>: ${content}; `;
        }
        return html;
      },

      _makePrintableContent(label, content, value, def, data) {
        let i, style;
        if ((content.length === 0) && (value.length === 0) && (def.type !== 'label')) { return ''; }
        const { print } = def;

        // console.log label, print

        let labelHtml = '';
        let contentHtml = '';
        let valueHtml = '';

        if (print.hide) { return ''; }

        if (label.length > 0) {
          if (!print.hideLabel) {
            style = '';
            if (print.boldLabel) {
              style += 'font-weight: bold;';
            }
            if (print.fontSize) {
              style += `font-size:${print.fontSize}px;`;
            }
            labelHtml = `<span style="${style}">${label}</span>`;
          }
        }

        if (value.length > 0) {
          if (!print.hideValue) {
            style = '';
            if (print.boldValue) {
              style += 'font-weight: bold;';
            }
            if (print.fontSize) {
              style += `font-size:${print.fontSize}px;`;
            }
            valueHtml = `<span style="${style}">${value}</span>`;
          }
        }

        if (content.length > 0) {
          if (!print.hideChildren) {
            style = '';
            if (print.boldChildren) {
              style += 'font-weight: bold;';
            }
            contentHtml = `<span style="${style}">${content}</span>`;
          }
        }

        if ((labelHtml + contentHtml + valueHtml).length === 0) {
          return '';
        }

        if ('newLineBeforeThis' in print) {
          let asc, end;
          for (i = 0, end = print.newLineBeforeThis, asc = 0 <= end; asc ? i < end : i > end; asc ? i++ : i--) {
            labelHtml = `<br>${labelHtml}`;
          }
        }

        if ('newLineAfterThis' in print) {
          let asc1, end1;
          for (i = 0, end1 = print.newLineAfterThis, asc1 = 0 <= end1; asc1 ? i < end1 : i > end1; asc1 ? i++ : i--) {
            labelHtml = labelHtml + '<br>';
          }
        }

        const colon = (('noColonAfterThis' in print && print.noColonAfterThis) || (labelHtml.length === 0) ? '' : ': ');
        const semicolon = ('noSemicolonAfterThis' in print && print.noSemicolonAfterThis ? '' : '; ');
        let html = labelHtml + colon + contentHtml + valueHtml + semicolon;

        if ('newLineAfterThisAndChildren' in print) {
          let asc2, end2;
          for (i = 0, end2 = print.newLineAfterThisAndChildren, asc2 = 0 <= end2; asc2 ? i < end2 : i > end2; asc2 ? i++ : i--) {
            html = html + '<br>';
          }
        }

        return html;
      },


      type_card(def, data) {
        const content = (this.handle_children(def, data));
        const { label } = def;
        const value = null;
        return this._makePrintableContent((label || ''), (content || ''), (value || ''), def, data);
      },

      type_checkbox(def, data) {
        let value;
        const content = null;
        const label = null;

        if (data.isChecked) {
          value = def.label;
        } else {
          value = '';
        }

        return this._makePrintableContent((label || ''), (content || ''), (value || ''), def, data);
      },

      type_label(def, data) {
        const content = null;
        const label = data.label || def.label || def.defaultLabel;
        const value = null;

        return this._makePrintableContent((label || ''), (content || ''), (value || ''), def, data);
      },

      type_toggleableContainer(def, data) {
        if (!data.isChecked) { return ''; }

        const content = this.handle_children(def, data);
        const { label } = def;
        const value = null;

        return this._makePrintableContent((label || ''), (content || ''), (value || ''), def, data);
      },

      type_container(def, data) {
        const content = this.handle_children(def, data);
        const label = data.label || def.defaultLabel;
        const value = null;

        return this._makePrintableContent((label || ''), (content || ''), (value || ''), def, data);
      },

      type_checkList(def, data) {
        const { print } = def;

        const stringList = [];
        for (let item of Array.from(data.checkedValueList)) {
          stringList.push(item);
        }

        let { separatorString } = print;
        if ('newLineAfterEachValue' in print) {
          for (let i = 0, end = print.newLineAfterEachValue, asc = 0 <= end; asc ? i < end : i > end; asc ? i++ : i--) {
            separatorString += '<br>';
          }
        }

        const value = stringList.join(separatorString);

        const label = null;
        const content = null;

        return this._makePrintableContent((label || ''), (content || ''), (value || ''), def, data);
      },

      type_radioList(def, data) {
        const value = data.selectedValue;
        const label = null;
        const content = null;

        return this._makePrintableContent((label || ''), (content || ''), (value || ''), def, data);
      },

      type_singleSelectDropdown(def, data) {
        const value = def.possibleValueList[data.selectedIndex];
        const label = null;
        const content = null;

        return this._makePrintableContent((label || ''), (content || ''), (value || ''), def, data);
      },

      type_input(def, data) {
        let content = data.value;

        if (def.unitDetails) {
          const unit = def.unitDetails.unitList[data.selectedUnitIndex];
        }
        // content += ' ' + unit.name

        const value = content;
        const { label } = def;
        content = null;

        return this._makePrintableContent((label || ''), (content || ''), (value || ''), def, data);
      },

      type_autocomplete(def, data) {
        let content, key, label, title, value;
        const { print } = def;

        if (def.selectionType === 'label') {

          const stringList = [];
          for (key in data.virtualChildMap) {
            value = data.virtualChildMap[key];
            title = key.split('_');
            title.pop();
            title.shift();
            title = title.join('_');
            stringList.push(title);
          }

          let { separatorString } = print;
          if ('newLineAfterEachValue' in print) {
            for (let i = 0, end = print.newLineAfterEachValue, asc = 0 <= end; asc ? i < end : i > end; asc ? i++ : i--) {
              separatorString += '<br>';
            }
          }

          value = stringList.join(separatorString);

          ({ label } = def);
          content = null;

          return this._makePrintableContent((label || ''), (content || ''), (value || ''), def, data);

        } else {
          content = '';
          for (key in data.virtualChildMap) {
            value = data.virtualChildMap[key];
            title = key.split('_');
            title.pop();
            title.shift();
            title = title.join('_');

            const virtualContainer = {
              type: 'container',
              defaultLabel: title,
              key,
              childList: def.childListForEachContainer
            };

            const childContent = (this.handle_type(virtualContainer, value)) + ', ';
            content += childContent;
          }

          value = null;
          ({ label } = def);

          return this._makePrintableContent((label || ''), (content || ''), (value || ''), def, data);
        }
      },

      type_incrementalCounter(def, data) {
        let content = '';
        for (let key in data.virtualChildMap) {
          let value = data.virtualChildMap[key];
          const title = key.replace('item', '');
          const serial = parseInt(title);

          const virtualContainer = {
            type: 'container',
            defaultLabel: ((() => { try { return def.unit.singular; } catch (ex) { return 'unit'; } })()) + ' #' + (serial + 1),
            key,
            childList: def.childListForEachContainer
          };

          content += (this.handle_type(virtualContainer, value)) + ';';

          value = null;
          const { label } = def;
          return this._makePrintableContent((label || ''), (content || ''), (value || ''), def, data);
        }
      },

      /*
        REGION - PRINT RELATED CHECKS
      */

      should_boldLabel(def) {
        return 'print' in def && 'boldLabel' in def.print && def.print.boldLabel;
      },

      should_passThrough(def) {
        return 'print' in def && 'passThrough' in def.print && def.print.passThrough;
      },

      should_newLineBeforeThis(def) {
        return 'print' in def && 'newLineBeforeThis' in def.print && def.print.newLineBeforeThis;
      },

      inject_passThrough_special_card(def, data) {
        if ((def.key === def.label) && ["Details", 'Default'].includes(def.key)) {
          if (!def.print) { def.print = {}; }
          return def.print.passThrough = true;
        }
      },

      inject_passThrough_special_group(def, data) {
        if ((def.key === def.label) && ["List", 'Default'].includes(def.key)) {
          if (!def.print) { def.print = {}; }
          return def.print.passThrough = true;
        }
      },

      __debug_print(def, handledDirectiveList) {
        const all = 'print' in def ? Object.keys(def.print) : [];
        const left = lib.array.minus(all, handledDirectiveList);
        if (left.length > 0) {
          return console.log('UNHANDLED print directives', def, left);
        }
      },

      //# VIEW :: HistoryAndPhysical - end
      checkForPrintPreviewType() {

        if (this.visit.historyAndPhysicalRecordSerial) {
          return false;
        }
        if (this.visit.identifiedSymptomsSerial) {
          return false;
        } else if (this.visit.examinationSerial) {
          return false;
        } else if (this.visit.vitalSerial.bp) {
          return false;
        } else if (this.visit.vitalSerial.hr) {
          return false;
        } else if (this.visit.vitalSerial.bmi) {
          return false;
        } else if (this.visit.vitalSerial.rr) {
          return false;
        } else if (this.visit.vitalSerial.spo2) {
          return false;
        } else if (this.visit.vitalSerial.temp) {
          return false;
        } else if (this.visit.advisedTestSerial) {
          return false;
        } else if (this.visit.diagnosisSerial) {
          return false;
        } else if (this.visit.doctorNotesSerial) {
          return false;
        } else if (this.visit.nextVisitSerial) {
          return false;
        } else {
          return true;
        }
      },



      saveVisitSettings() {
        this.recordTitleValueChanged();
        return this.$$('#dialogVisitSettings').close();
      },


      _getRecordSerial(data) {
        if (typeof data === 'undefined') {
          return 'new';
        } else if (data === 'new') {
          return data;
        } else { return data; }
      }



    });
  </script>
</dom-module>