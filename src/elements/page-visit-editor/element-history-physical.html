<link rel="import" href="../../behaviors/common-computes.html">
<link rel="import" href="../../behaviors/db-using.html">
<link rel="import" href="../../behaviors/translating.html">
<link rel="import" href="../../behaviors/api-calling.html">

<link rel="import" href="../../bower-assets/iron-icons/iron-icons.html">
<link rel="import" href="../../bower-assets/paper-button/paper-button.html">
<link rel="import" href="../../bower-assets/paper-card/paper-card.html">
<link rel="import" href="../../bower-assets/paper-input/paper-input.html">
<link rel="import" href="../../bower-assets/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower-assets/paper-menu/paper-menu.html">
<link rel="import" href="../../bower-assets/paper-item/paper-item.html">
<link rel="import" href="../../bower-assets/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower-assets/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower-assets/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../styles/common-style.html">
<link rel="import" href="visit-common-styles.html">

<!-- custom-elements -->
<link rel="import" href="../html-block/html-block.html">

<dom-module id="element-history-physical">
  <template>
    <style is="custom-style" include="common-style visit-common-styles">
    </style>

    <div class="card-item-2">

      <!-- preview-title - start -->
      <div class="preview-title layout wrap">
        <!-- <iron-icon class="m-right-8" src="../../images/icons/ico_history_and_physical.png"></iron-icon> -->

        <div class="type title-2 flex">History &amp; Physical</div>


        <div class="layout horizontal wrap">


          <template is="dom-if" if="[[_isEmptyString(visit.historyAndPhysicalRecordSerial)]]">
            <paper-button class="btn-add" on-tap="historyAndPhysicalRecordCreate">
              <iron-icon icon="icons:add"></iron-icon>
            </paper-button>


            <template is="dom-if" if="[[recordInClipboard]]">
              <paper-button class="btn-add btn btn-default" on-tap="pasteRecordPressed">
                <iron-icon icon="icons:content-paste" class="m-right-8"></iron-icon>Paste Record: [[recordInClipboard.serial]]
              </paper-button>
            </template>
          </template>

          <template is="dom-if" if="[[!_isEmptyString(visit.historyAndPhysicalRecordSerial)]]">
            <paper-checkbox checked="[[historyAndPhysicalRecord.availableToPatient]]" on-change="historyAndPhysicalAvailableToPatientCheckBoxChanged">Available to Patient</paper-checkbox>

            <!-- <paper-icon-button icon="print" on-tap="historyAndPhysicalRecordPrint"></paper-icon-button> -->

            <paper-icon-button icon="create" on-tap="historyAndPhysicalRecordEdit"></paper-icon-button>
            <paper-icon-button icon="icons:content-copy" on-tap="historyAndPhysicalRecordCopy"></paper-icon-button>
            <paper-icon-button icon="icons:delete" on-tap="historyAndPhysicalRecordRemove"></paper-icon-button>

            <!-- <div>[[$mkDate(record.content.preopAssessment.lastChangedDatetimeStamp)]]</div> -->
          </template>
        </div>
      </div>
      <!-- preview-title - end -->


      <template is="dom-if" if="[[shouldRender]]">
        <div class="p-horizontal-16" style="background: #fff;">
          <html-block html="[[recordPartHtmlContent]]"></html-block>
        </div>
      </template>
    </div>

  </template>
  <script src="mixin-utils.js"></script>
  <script>
    Polymer({
      is: 'element-history-physical',
      behaviors: [
        app.behaviors.commonComputes,
        app.behaviors.dbUsing,
        app.behaviors.translating,
        app.behaviors.apiCalling,
        app.behaviors.local.visitUtilsMixin
      ],
      properties: {
        patient: {
          type: Object,
          observer: 'patientValueChanged'
        },
        user: {
          type: Object
        },
        visit: {
          type: Object,
          observer: 'visitValueChanged'
        },
        organization: {
          type: Object
        },
        historyAndPhysicalRecord: {
          type: Object
        },
        matchingRecordList: {
          type: Object
        }
      },

      attached: function () {
        this.historyAndPhysicalRecord = {}
      },

      detached: function () {

      },

      patientValueChanged: function (patient) {
        this.historyAndPhysicalRecord = {}
      },

      visitValueChanged: function (visit) {
        console.log('visit:', visit);
        if (visit.serial) {
          if (visit.historyAndPhysicalRecordSerial) {
            this.historyAndPhysical_navigatedIn();

            this.set('recordPartName', 'history-and-physical-record');

            this.recordDatabaseCollectionName = 'history-and-physical-record';

            this.record = this._getRecord(this.visit.historyAndPhysicalRecordSerial, this.recordDatabaseCollectionName);

            this.recordPartData = this.record;

            this.recordPartTitle = 'History and Physical Record';

            this.domHost.getStaticData('dynamicElementDefinitionPreoperativeAssessment', def => {

              this.recordPartDef = def;

              this.recordPartHtmlContent = this.generateHtmlContent(this.recordPartDef, this.recordPartData);

              // console.log @recordPartHtmlContent

              if (!this.delayRendering) {

                return this.shouldRender = true;
              }
            });
          }
        }
      },

      historyAndPhysicalAvailableToPatientCheckBoxChanged(e) {
        if (this.historyAndPhysicalRecord) {
          if (e.target.checked) {
            this.historyAndPhysicalRecord.availableToPatient = true;
            return this._saveHistoryAndPhysicalRecord();
          } else {
            this.historyAndPhysicalRecord.availableToPatient = false;
            return this._saveHistoryAndPhysicalRecord();
          }
        }
      },

      historyAndPhysical_navigatedIn() {
        this._loadHistoryAndPhysicalRecord();
        this._loadRecordInClipboard();
      },

      historyAndPhysicalRecordCreate(e) {
        const params = this.domHost.getPageParams();
        if (params['visit'] === 'new') {
          this._saveVisit();
        }
        // console.log @visit.serial
        this.historyAndPhysicalRecord = {
          lastModifiedDatetimeStamp: lib.datetime.now(),
          createdDatetimeStamp: lib.datetime.now(),
          lastSyncedDatetimeStamp: 0,
          createdByUserSerial: this.user.serial,
          serial: this.generateSerialForHistoryAndPhysical(),
          patientSerial: this.patient.serial,
          visitSerial: this.visit.serial,
          availableToPatient: true
        };

        this.visit.historyAndPhysicalRecordSerial = this.historyAndPhysicalRecord.serial;
        this.visit.lastModifiedDatetimeStamp = lib.datetime.now();

        // updated visit object for History and Physical
        app.db.upsert('doctor-visit', this.visit, ({ serial }) => this.visit.serial === serial);


        this._saveHistoryAndPhysicalRecord();
        this._loadHistoryAndPhysicalRecord();
        this.domHost.navigateToPage(`#/record-history-and-physical/record:${this.historyAndPhysicalRecord.serial}`);
        return window.location.reload();
      },


      _loadRecordInClipboard() {
        let recordInClipboard = sessionStorage.getItem('HISTORY-AND-PHYSICAL-IN-CLIPBOARD');
        if (recordInClipboard) {
          recordInClipboard = JSON.parse(recordInClipboard);
        }
        return this.recordInClipboard = recordInClipboard;
      },

      historyAndPhysicalRecordCopy(e) {
        const record = this.historyAndPhysicalRecord;
        // console.log record

        sessionStorage.setItem('HISTORY-AND-PHYSICAL-IN-CLIPBOARD', JSON.stringify(record));
        this.domHost.showModalDialog("This record has been copied to clipboard");
        return this._loadRecordInClipboard();
      },

      pasteRecordPressed(e) {
        const params = this.domHost.getPageParams();
        if (params['visit'] === 'new') {
          this._saveVisit();
        }

        this.recordInClipboard.patientSerial = this.patient.serial;
        this.recordInClipboard.visitSerial = this.visit.serial;
        this.recordInClipboard.lastChangedDatetimeStamp = lib.datetime.now();
        this.recordInClipboard.serial = this.generateSerialForRecord();

        this.visit.historyAndPhysicalRecordSerial = this.recordInClipboard.serial;
        this.historyAndPhysicalRecord = this.recordInClipboard;


        // updated visit object for History and Physical
        app.db.upsert('doctor-visit', this.visit, ({ serial }) => this.visit.serial === serial);

        this._saveHistoryAndPhysicalRecord();
        this._loadHistoryAndPhysicalRecord();

        this.recordInClipboard = null;
        sessionStorage.removeItem('HISTORY-AND-PHYSICAL-IN-CLIPBOARD');

        this.domHost.showModalDialog("Successfully Imported. Reloading Interface.");

        this.domHost.navigateToPage(`#/record-history-and-physical/record:${this.historyAndPhysicalRecord.serial}`);
        return window.location.reload();
      },

      _updateVisitForHistoryAndPhysicalRecord(historyAndPhysicalRecordIdentifier) { },

      historyAndPhysicalRecordPrint(e) {
        return this.domHost.navigateToPage(`#/print-history-and-physical-record/record:${this.historyAndPhysicalRecord.serial}`);
      },

      historyAndPhysicalRecordEdit(e) {
        return this.domHost.navigateToPage(`#/record-history-and-physical/record:${this.historyAndPhysicalRecord.serial}`);
      },

      historyAndPhysicalRecordRemove(e) {
        return this.domHost.showModalPrompt('Are you sure?', answer => {
          if (answer) {
            app.db.remove('history-and-physical-record', this.historyAndPhysicalRecord._id);
            return this._loadHistoryAndPhysicalRecord();
          }
        });
      },

      _loadHistoryAndPhysicalRecord() {
        const currentVisitSerial = this.visit.serial;
        const list = app.db.find('history-and-physical-record', ({ visitSerial }) => visitSerial === currentVisitSerial);
        if (list.length === 1) {
          this.set('historyAndPhysicalRecord', list[0]);
        } else {
          this.set('historyAndPhysicalRecord', null);
        }

        return console.log('_loadHistoryAndPhysicalRecord', this.historyAndPhysicalRecord);
      },

      _saveVisitPrescription() {
        app.db.upsert('visit-prescription', this.prescription, ({ serial }) => this.prescription.serial === serial);
        return this.domHost.showToast('Record Saved');
      },

      _saveVisitTestAdvised() {
        app.db.upsert('visit-advised-test', this.testAdvised, ({ serial }) => this.testAdvised.serial === serial);
        return this.domHost.showToast('Record Saved');
      },

      _saveHistoryAndPhysicalRecord() {
        app.db.upsert('history-and-physical-record', this.historyAndPhysicalRecord, ({ serial }) => this.historyAndPhysicalRecord.serial === serial);
        return this.domHost.showToast('Record Saved');
      }
    });
  </script>
</dom-module>