<!-- behavior -->
<link rel="import" href="../../behaviors/common-computes.html">
<link rel="import" href="../../behaviors/db-using.html">
<link rel="import" href="../../behaviors/translating.html">
<link rel="import" href="../../behaviors/api-calling.html">

<link rel="import" href="../../bower-assets/iron-icons/iron-icons.html">
<link rel="import" href="../../bower-assets/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower-assets/paper-button/paper-button.html">
<link rel="import" href="../../bower-assets/paper-card/paper-card.html">
<link rel="import" href="../../bower-assets/paper-input/paper-input.html">
<link rel="import" href="../../bower-assets/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower-assets/paper-menu/paper-menu.html">
<link rel="import" href="../../bower-assets/paper-item/paper-item.html">
<link rel="import" href="../../bower-assets/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower-assets/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower-assets/paper-icon-button/paper-icon-button.html">
<!-- Custom AutoComplete -->
<link rel="import" href="../../bower-assets/paper-autocomplete/paper-autocomplete.html">

<!-- style -->
<link rel="import" href="../../styles/common-style.html">
<link rel="import" href="visit-common-styles.html">

<dom-module id="element-refferal">
  <template>
    <style is="custom-style" include="common-style visit-common-styles">
    </style>
    <div class="card-item-2">
      <div class="preview-title layout">
        <div class="type title-2 flex">Referral</div>
        <div class="action-area">
          <paper-button class="btn-add m-vert" on-tap="openReferralDialogPressed">
            <iron-icon icon="icons:add"></iron-icon>
          </paper-button>
        </div>
      </div>

      <div class="card-content">
        <div class="layout horizontal">
          <span class="type bold">Referred By: </span> [[referral.data.referredByDoctorName]]
        </div>
        <template is="dom-if" if="[[referral.data.doctorName]]">
          <div class="layout horizontal">
            <span class="type bold">Referred To: </span> [[referral.data.doctorName]]
          </div>
          <div class="layout horizontal">
            <span class="type bold">Speciality: </span> [[referral.data.speciality]]</div>
        </template>
        <template is="dom-if" if="[[referral.data.organizationName]]">
          <div class="layout horizontal">
            <span class="type bold">Organization Name: </span> [[referral.data.organizationName]]</div>
        </template>
      </div>

    </div>
    <!-- Dialog for - Referral start -->
    <paper-dialog id="dialogReferral" style="width: 360px">
      <h2>Add Referral</h2>
      <div class="p-16">
        <paper-dropdown-menu label="Select Referral Type">
          <paper-listbox class="dropdown-content" selected="{{selectedReferralTypeIndex}}">
            <paper-item>Doctor</paper-item>
            <paper-item>Hospital</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>

        <template is="dom-if" if="[[!selectedReferralTypeIndex]]">
          <paper-input label="Referred By" value="[[user.name]]"></paper-input>
          <div>
            <paper-autocomplete id="doctorSearch" label="[[$TRANSLATE('Search for Doctor',LANG)]]" text="{{doctorSearchFieldInput}}"
              text-property="name" value-property="idOnServer" remote-source="true" on-autocomplete-reset="doctorSearchCleared"
              on-keyup="doctorSearchStartKeyPressed" error-message="Input Required" required>
              <template autocomplete-custom-template>
                <paper-item on-tap="_onSelect" id$="[[_getSuggestionId(index)]]" role="option" aria-selected="false">
                  <paper-item-body two-line>
                    <div class="type bold">[[item.name]]</div>
                    <div secondary>
                      <span class="type secondary caption-2">([[item.phone]])</span>
                      <span class="type secondary caption-2 m-left-8">[[item.email]]</span>
                    </div>
                  </paper-item-body>
                  <paper-ripple></paper-ripple>
                </paper-item>
              </template>
            </paper-autocomplete>
            <paper-button class="btn btn-success" on-tap="doctorSearchButtonPressed">Search</paper-button>
          </div>
          <paper-dropdown-menu label="Specialist Type">
            <paper-listbox class="dropdown-content" selected="{{referredDoctorSpecialitySelectedIndex}}">
              <template is="dom-repeat" items="[[referredDoctorSpecialityList]]">
                <paper-item>[[item]]</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
        </template>


        <template is="dom-if" if="[[selectedReferralTypeIndex]]">
          <paper-autocomplete class="flex" id="organizationSearch" label="[[$TRANSLATE('Search for Hospital',LANG)]]" text="{{organizationSearchFieldInput}}"
            text-property="name" value-property="idOnServer" remote-source="true" on-autocomplete-selected="organizationSelected"
            on-autocomplete-reset="organizationSearchCleared" on-keyup="organizationSearchStartKeyPressed" error-message="Input Required"
            required>
            <template autocomplete-custom-template>
              <paper-item on-tap="_onSelect" id$="[[_getSuggestionId(index)]]" role="option" aria-selected="false">
                <div class="type bold">[[item.name]]</div>
                <paper-ripple></paper-ripple>
              </paper-item>
            </template>
          </paper-autocomplete>
          <paper-button class="btn btn-success" on-tap="organizationSearchButtonPressed">Search</paper-button>
        </template>
      </div>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button class="btn btn-primary" on-tap="addReferralButtonClicked">Add Referral</paper-button>
      </div>
    </paper-dialog>
    <!-- Dialog for - Referral start -->
  </template>
  <script src="mixin-utils.js"></script>
  <script>
    Polymer({
      is: 'element-refferal',
      behaviors: [
        app.behaviors.commonComputes,
        app.behaviors.dbUsing,
        app.behaviors.translating,
        app.behaviors.apiCalling,
        app.behaviors.local.visitUtilsMixin
      ],
      properties: {
        patient: Object,
        user: Object,
        visit: {
          type: Object,
          observer: 'visitValueChanged'
        },
        organization: {
          type: Object
        },
        referral: {
          type: Object,
          value: function () {
            return {};
          }
        },
        selectedReferralTypeIndex: {
          type: Number,
          value: function () {
            return 0;
          }
        },
        referredDoctorSpecialityList: {
          type: Array,
          value: function () {
            return ["Cardiology", "General Surgery", "Haemotology", "Neuro surgery", "Neuro medicine", "Oncology", "Oral-maxillo-facial surgery", "Physical medicine", "Psychiatry", "Respiratory medicine", "Rapid access clinic", "Radiology"];
          }
        }
      },

      attached: function () {

      },

      detached: function () {

      },

      visitValueChanged: function (visit) {

        if (!visit) return
        if (!visit.serial) {
        }
        if (visit.serial) {
          if (visit.hasOwnProperty('referralSerial') && visit.referralSerial) {
            this._loadReferral(visit.referralSerial);
          }
        }
      },

      // Methods
      _loadReferral: function (referralSerialIdentifier) {
        return lib.util.delay(5, (function (_this) {
          return function () {
            var list;
            list = app.db.find('referral-record', function (arg) {
              var serial;
              serial = arg.serial;
              return serial === referralSerialIdentifier;
            });
            if (list.length === 1) {
              _this.referral = list[0];
              return true;
            }
          };
        })(this));
      },
      _makeNewReferral: function () {
        return this.referral = {
          serial: null,
          lastModifiedDatetimeStamp: lib.datetime.now(),
          createdDatetimeStamp: lib.datetime.now(),
          lastSyncedDatetimeStamp: 0,
          createdByUserSerial: this.user.serial,
          visitSerial: null,
          patientSerial: this.patient.serial,
          doctorName: this.visit.doctorName,
          doctorSpeciality: this.visit.doctorSpeciality,
          data: {}
        };
      },
      _saveReferral: function () {
        if (this.visit.serial === null) {
          this.domHost._saveVisit();
          this.referral.visitSerial = this.visit.serial;
        }
        if (this.referral.serial === null) {
          this.referral.serial = this.generateSerialForReferral();
          this.visit.referralSerial = this.referral.serial;
          this.referral.visitSerial = this.visit.serial;
          this.domHost._saveVisit();
        }
        console.log('referral', this.referral);
        this.referral.lastModifiedDatetimeStamp = lib.datetime.now();
        return app.db.upsert('referral-record', this.referral, (function (_this) {
          return function (arg) {
            var serial;
            serial = arg.serial;
            return _this.referral.serial === serial;
          };
        })(this));
      },
      openReferralDialogPressed: function (e) {
        return this.$.dialogReferral.toggle();
      },
      doctorSearchStartKeyPressed: function (e) {
        if (e.which !== 13) {
          return;
        }
        return this.doctorSearchButtonPressed();
      },
      doctorSearchButtonPressed: function () {
        return this.callApi('/bdemr-doctor-search', {
          searchQuery: this.doctorSearchFieldInput
        }, (function (_this) {
          return function (err, response) {
            var data, doctorSuggestionArray, item;
            if (response.hasError) {
              return _this.domHost.domHost.showModalDialog(response.error.message);
            } else {
              data = response.data;
              if (data.length > 0) {
                doctorSuggestionArray = (function () {
                  var i, len, results;
                  results = [];
                  for (i = 0, len = data.length; i < len; i++) {
                    item = data[i];
                    results.push(item);
                  }
                  return results;
                })();
                return _this.$$("#doctorSearch").suggestions(doctorSuggestionArray);
              } else {
                return _this.domHost.domHost.showToast('No Match Found');
              }
            }
          };
        })(this));
      },
      doctorSearchCleared: function () {
        return this.set('searchFieldMainInput', '');
      },
      organizationSearchStartKeyPressed: function (e) {
        if (e.which !== 13) {
          return;
        }
        return this.organizationSearchButtonPressed();
      },
      organizationSearchButtonPressed: function () {
        var data;
        data = {
          apiKey: this.user.apiKey,
          searchString: this.organizationSearchFieldInput
        };
        return this.callApi('/bdemr-organization-search', data, (function (_this) {
          return function (err, response) {
            var item, organizationSuggestionArray;
            if (response.hasError) {
              return _this.domHost.domHost.showModalDialog(response.error.message);
            } else {
              data = response.data.matchingOrganizationList;
              if (data.length > 0) {
                organizationSuggestionArray = (function () {
                  var i, len, results;
                  results = [];
                  for (i = 0, len = data.length; i < len; i++) {
                    item = data[i];
                    results.push(item);
                  }
                  return results;
                })();
                return _this.$$("#organizationSearch").suggestions(organizationSuggestionArray);
              } else {
                return _this.domHost.domHost.showToast('No Match Found');
              }
            }
          };
        })(this));
      },
      addReferralButtonClicked: function () {
        var data;
        if (!(this.doctorSearchFieldInput || this.organizationSearchFieldInput)) {
          return;
        }
        data = {
          referredByDoctorName: this.user.name,
          referredByDoctorId: this.user.idOnServer,
          selectedReferralType: "",
          doctorName: "",
          doctorId: "",
          speciality: "",
          organizationName: "",
          organizationId: ""
        };
        if (this.selectedReferralTypeIndex === 0) {
          data.doctorName = this.doctorSearchFieldInput;
          data.speciality = this.referredDoctorSpecialityList[this.referredDoctorSpecialitySelectedIndex];
          data.doctorId = this.$$("#doctorSearch").value;
        }
        if (this.selectedReferralTypeIndex === 1) {
          data.organizationName = this.organizationSearchFieldInput;
          data.organizationId = this.$$("#organizationSearch").value;
        }
        this.set('referral.data', data);
        this._saveReferral();
        return this.$.dialogReferral.toggle();
      }
    });
  </script>
</dom-module>