<!-- behavior -->
<link rel="import" href="../../behaviors/common-computes.html">
<link rel="import" href="../../behaviors/db-using.html">
<link rel="import" href="../../behaviors/translating.html">
<link rel="import" href="../../behaviors/api-calling.html">

<link rel="import" href="../../bower-assets/iron-icons/iron-icons.html">
<link rel="import" href="../../bower-assets/paper-button/paper-button.html">
<link rel="import" href="../../bower-assets/paper-card/paper-card.html">
<link rel="import" href="../../bower-assets/paper-input/paper-input.html">
<link rel="import" href="../../bower-assets/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower-assets/paper-menu/paper-menu.html">
<link rel="import" href="../../bower-assets/paper-item/paper-item.html">
<link rel="import" href="../../bower-assets/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower-assets/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower-assets/paper-icon-button/paper-icon-button.html">

<!-- style -->
<link rel="import" href="../../styles/common-style.html">
<link rel="import" href="visit-common-styles.html">

<dom-module id="element-notes">
  <template>
    <style is="custom-style" include="common-style visit-common-styles">
    </style>
    <div class="card-item-2">
      <div class="preview-title">
        <!-- <iron-icon class="m-right-8" src="../../images/icons/ico_notes.png"></iron-icon> -->
        <div class="flex">
          <paper-input class="paper-input-custom" label="Note/Advised" value="{{doctorNotesMessage}}"></paper-input>
        </div>
        <div class="action-area">
          <paper-button class="btn-add" on-tap="_addNotePressed">
            <iron-icon icon="icons:add"></iron-icon>
          </paper-button>
        </div>
      </div>
      <template is="dom-if" if="{{!_isEmpty(doctorNotes.data.messageList.length)}}">

        <div class="p-0 b-radius">
          <paper-listbox>
            <template is="dom-repeat" items="[[doctorNotes.data.messageList]]">
              <paper-item class="custom layout horizontal center">
                <div class="type caption secondary">[[_returnSerial(index)]]</div>
                <div class="m-left-8 flex type body" style="word-break: break-word;">
                  {{item}}
                </div>
                <paper-icon-button icon="delete" on-tap="_onDoctorNoteDeletedButtonPressed"></paper-icon-button>
              </paper-item>
            </template>
          </paper-listbox>
        </div>
      </template>
    </div>
  </template>
  <script src="mixin-utils.js"></script>
  <script>
    Polymer({
      is: 'element-notes',
      behaviors: [
        app.behaviors.commonComputes,
        app.behaviors.dbUsing,
        app.behaviors.translating,
        app.behaviors.apiCalling,
        app.behaviors.local.visitUtilsMixin
      ],
      properties: {
        patient: Object,
        user: Object,
        visit: {
          type: Object,
          observer: 'visitValueChanged'
        },
        organization: {
          type: Object
        },
        doctorNotes: {
          type: Object,
          notify: true,
          value: null
        },
        doctorNotesMessage: {
          type: String,
          notify: true,
          value: ''
        },
        isNoteValid: {
          type: Boolean,
          notify: false,
          value: false
        }
      },

      attached() {

      },

      detached() {

      },

      visitValueChanged(visit) {

        if (!visit) return
        if (!visit.serial) {
          this._makeNewNote()
        }
        if (visit.serial) {
          if (visit.hasOwnProperty('doctorNotesSerial') && visit.doctorNotesSerial) {
            this._loadVisitNote(visit.doctorNotesSerial);
          }
        }
      },

      // Methods
      _makeNewNote() {
        this.doctorNotes = {
          serial: null,
          lastModifiedDatetimeStamp: 0,
          createdDatetimeStamp: 0,
          lastSyncedDatetimeStamp: 0,
          createdByUserSerial: null,
          visitSerial: null,
          patientSerial: this.patient.serial,
          doctorName: this.user.name,
          doctorSpeciality: this.getDoctorSpeciality(),
          data: {
            messageList: []
          }
        };
        return this.isNoteValid = true;
      },
      _saveNote(data) {
        data.lastModifiedDatetimeStamp = lib.datetime.now();
        return app.db.upsert('visit-note', data, (function (_this) {
          return function (arg) {
            var serial;
            serial = arg.serial;
            return data.serial === serial;
          };
        })(this));
      },
      _addNotePressed() {
        if (this.doctorNotesMessage !== '') {
          this.push('doctorNotes.data.messageList', this.doctorNotesMessage);
          if (this.doctorNotes.serial === null) {
            this.doctorNotes.createdDatetimeStamp = lib.datetime.now();
            this.doctorNotes.serial = this.generateSerialForNote();
          }
          if (this.visit.doctorNotesSerial === null) {
            this.visit.doctorNotesSerial = this.doctorNotes.serial;
            this._saveVisit();
          }
          this._saveNote(this.doctorNotes);
          this.doctorNotesMessage = '';
          this._loadVisitNote(this.doctorNotes.serial);
          return this.domHost.domHost.showToast('Note Saved.');
        }
      },
      _loadVisitNote(doctorNotesSerialIdentifier) {
        var list;
        list = app.db.find('visit-note', function (arg) {
          var serial;
          serial = arg.serial;
          return serial === doctorNotesSerialIdentifier;
        });
        if (list.length === 1) {
          this.isNoteValid = true;
          this.isFullVisitValid = true;
          this.doctorNotes = list[0];
          console.log('NOTES: ', this.doctorNotes);
          return true;
        } else {
          this.isNoteValid = false;
          return false;
        }
      },
      _onDoctorNoteDeletedButtonPressed(e) {
        var index;
        index = e.model.index;
        return this.domHost.domHost.showModalPrompt('Are you sure?', (function (_this) {
          return function (answer) {
            if (answer === true) {
              _this.splice('doctorNotes.data.messageList', index, 1);
              return app.db.upsert('visit-note', _this.doctorNotes, function (arg) {
                var serial;
                serial = arg.serial;
                return _this.doctorNotes.serial === serial;
              });
            }
          };
        })(this));
      }
    });
  </script>
</dom-module>