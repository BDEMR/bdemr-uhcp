<!-- behavior -->
<link rel="import" href="../../behaviors/common-computes.html">
<link rel="import" href="../../behaviors/db-using.html">
<link rel="import" href="../../behaviors/translating.html">
<link rel="import" href="../../behaviors/api-calling.html">

<link rel="import" href="../../bower-assets/iron-icons/iron-icons.html">
<link rel="import" href="../../bower-assets/paper-button/paper-button.html">
<link rel="import" href="../../bower-assets/paper-card/paper-card.html">
<link rel="import" href="../../bower-assets/paper-input/paper-input.html">
<link rel="import" href="../../bower-assets/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower-assets/paper-menu/paper-menu.html">
<link rel="import" href="../../bower-assets/paper-item/paper-item.html">
<link rel="import" href="../../bower-assets/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower-assets/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower-assets/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../styles/common-style.html">
<link rel="import" href="visit-common-styles.html">

<dom-module id="element-invoice">
  <template>
    <style is="custom-style" include="common-style visit-common-styles">
    </style>

    <div class="card-item-2">

      <div class="preview-title layout">
        <!-- <iron-icon class="m-right-8" src="../../images/icons/ico_invoice.png"></iron-icon> -->
        <div class="type title-2 flex">Invoice</div>
        <div class="action-area">
          <template is="dom-if" if="{{!isInvoiceValid}}">
            <paper-button class="btn-add m-vert" on-tap="createInvoicePressed">
              <iron-icon icon="icons:add"></iron-icon>
            </paper-button>
          </template>
          <template is="dom-if" if="{{isInvoiceValid}}">
            <paper-button class="btn-add m-vert" on-tap="printInvoicePressed">
              <iron-icon icon="icons:print"></iron-icon>
            </paper-button>
            <paper-button class="btn-add m-vert" on-tap="editInvoicePressed">
              <iron-icon icon="icons:create"></iron-icon>
            </paper-button>
          </template>
        </div>
      </div>

      <template is="dom-if" if="[[visit.invoiceSerial]]">
        <div class="card-content">
          <table class="table">
            <thead>
              <tr>
                <th>Service</th>
                <th>Price</th>
              </tr>
            </thead>
            <tbody>
              <template is="dom-repeat" items="[[invoice.data]]">
                <tr>
                  <td>[[item.name]]</td>
                  <td>
                    [[item.price]]
                    <paper-icon-button class="type danger" icon="delete" on-tap="deleteInvoiceItem"></paper-icon-button>
                  </td>
                </tr>
              </template>
            </tbody>
            <tfoot>
              <tr>
                <th>Total</th>
                <th>[[invoice.totalBilled]]</th>
              </tr>
              <tr>
                <td>Available Outdoor Balance</td>
                <td>[[patientOrganizationWallet.outdoorBalance]]</td>
              </tr>
              <tr>
                <th>Balance After Deduction</th>
                <th>[[calculatedOutDoorBalanceAfterDeduction(patientOrganizationWallet.outdoorBalance, invoice.totalBilled)]]</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </template>
    </div>
  </template>
  <script src="mixin-utils.js"></script>
  <script src="invoice-module.coffee-compiled.js"></script>
  <script>
    Polymer({
      is: 'element-invoice',
      behaviors: [
        app.behaviors.commonComputes,
        app.behaviors.dbUsing,
        app.behaviors.translating,
        app.behaviors.apiCalling,
        app.behaviors.local.visitUtilsMixin,
        app.behaviors.local.invoiceMixin
      ],
      properties: {
        patient: Object,
        user: Object,
        visit: {
          type: Object,
          observer: 'visitValueChanged'
        },
        organization: {
          type: Object
        },
        isInvoiceValid: {
          type: Boolean,
          notify: false,
          value: false
        },
        invoice: {
          type: Object,
          notify: true,
          value: {}
        }
      },

      observers: [
        'calculateTotalPrice(invoice.data.splices)',
      ],

      attached: function () {

      },

      detached: function () {

      },

      visitValueChanged: function (visit) {

        if (!visit) return
        if (!visit.serial) this.invoice = {}
        if (visit.serial) {
          if (visit.hasOwnProperty('invoiceSerial') && visit.invoiceSerial) {
            this._loadInvoice(visit.invoiceSerial);
          }
        }
      },

      _loadInvoice(invoiceIndentifier) {
        const list = app.db.find('visit-invoice', ({ serial }) => serial === invoiceIndentifier);

        if (list.length === 1) {
          this.isInvoiceValid = true;
          this.set('invoice', list[0]);
          console.log('Invoice:', this.invoice);
          return this.isInvoiceValid = true;
        } else {
          this.isInvoiceValid = false;
          return false;
        }
      },

      createInvoicePressed: function () {
        var params;
        params = this.domHost.domHost.getPageParams();
        if (params['visit'] === 'new') {
          this.visit.serial = this.generateSerialForVisit();
          this.visit.lastModifiedDatetimeStamp = lib.datetime.now();
          app.db.upsert('doctor-visit', this.visit, (function (_this) {
            return function (arg) {
              var serial;
              serial = arg.serial;
              return _this.visit.serial === serial;
            };
          })(this));
        }
        return this.domHost.domHost.navigateToPage('#/create-invoice/visit:' + this.visit.serial + '/patient:' + this.patient.serial + '/invoice:new');
      },
      editInvoicePressed: function (e) {
        return this.domHost.domHost.navigateToPage('#/create-invoice/visit:' + this.visit.serial + '/patient:' + this.patient.serial + '/invoice:' + this.invoice.serial);
      },
      printInvoicePressed: function () {
        var params;
        params = this.domHost.domHost.getPageParams();
        if (params['visit-invoice'] !== 'new') {
          return this.domHost.domHost.navigateToPage('#/print-invoice/visit:' + this.visit.serial + '/patient:' + this.patient.serial + '/invoice:' + this.invoice.serial);
        }
      },

      calculatedOutDoorBalanceAfterDeduction: function (opdBalance, totalBilled) {
        return (parseInt(opdBalance)) - (parseInt(totalBilled));
      },
      finishButtonPressed: function () {
        var ref;
        this.domHost.domHost.showSuccessToast('Visit Saved Successfully');
        this.domHost.domHost.navigateToPreviousPage();
        if ((ref = this.invoice) != null ? ref.totalBilled : void 0) {
          return this.chargeOutdoorWalletButtonPressed();
        }
      },

      _makeNewInvoice() {
        const invoice = {
          serial: this.generateSerialForinvoice(),
          referenceNumber: null,
          createdDatetimeStamp: lib.datetime.now(),
          createdByUserSerial: this.user.serial,
          patientSerial: this.patient.serial,
          patientName: this.patient.name,
          patientPhone: this.patient.phone,
          patientEmail: this.patient.email,
          organizationId: this.organization.idOnServer,
          organizationName: this.organization.name,
          modificationHistory: [],
          lastModifiedDatetimeStamp: null,
          category: '',
          totalBilled: 0,
          paid: null,
          lastPaid: null,
          discount: null,
          totalAmountReceieved: null,
          flags: {
            flagAsError: false,
            markAsCompleted: false
          },
          data: [],
          commission: {},
          availableToPatient: true
        };
        return this.set('invoice', invoice);
      },


      _reduceInventoryItems(invoice) {
        for (let item of invoice.data) {
          if (item.category === 'custom') { continue; }
          const doc = (app.db.find('organization-price-list', ({ serial }) => serial === item.serial))[0];
          if (doc.qty) {
            doc.qty -= item.qty;
            app.db.update('organization-price-list', doc._id, doc);
          }
        }
      },

      _addModificationHistory() {
        const modificationHistory = {
          userSerial: this.user.serial,
          lastModifiedDatetimeStamp: lib.datetime.now()
        };
        this.invoice.modificationHistory.push(modificationHistory);
        this.invoice.lastModifiedDatetimeStamp = lib.datetime.now();
      },

      _updateVisit(invoiceSerial) {
        if (this.visit.invoiceSerial === null) {
          this.set('visit.invoiceSerial', invoiceSerial);
        }
        this.domHost._saveVisit();
        // const params = this.domHost.domHost.getPageParams();
        // if (params['visit'] === 'new') {
        //   this.visit.serial = this.generateSerialForVisit();
        // }
        // if (this.visit.invoiceSerial === null) {
        //   this.set('visit.invoiceSerial', invoiceSerial);
        // }
        // this.visit.lastModifiedDatetimeStamp = lib.datetime.now();
        // app.db.upsert('doctor-visit', this.visit, ({ serial }) => this.visit.serial === serial);
      },

      _saveInvoice(markAsCompleted) {

        if (markAsCompleted) {
          this.invoice.flags.markAsCompleted = true;
        }

        this._addModificationHistory();

        // check for inventory items and reduce
        this._reduceInventoryItems(this.invoice);

        app.db.upsert('visit-invoice', this.invoice, ({ serial }) => serial === this.invoice.serial);
        this.domHost.domHost.showToast('Invoice Saved Successfully');
        this._updateVisit(this.invoice.serial);
        // return this.domHost.navigateToPage(`#/visit-editor/visit:${this.visit.serial}/patient:g`);
      },


      deleteInvoiceItem(e) {
        this.splice('invoice.data', e.model.index, 1);
        this._saveInvoice();
      },

      calculateTotalPrice() {
        if (!Object.keys(this.invoice).length) { return; }
        if (!this.invoice.data.length) {
          this.set('invoice.totalBilled', 0);
          return;
        }
        const price = this.invoice.data.reduce((total, item) => total + (parseInt((item.price * (item.qty || 1))))
          , 0);
        return this.set('invoice.totalBilled', price);
      }
    });
  </script>
</dom-module>