<link rel="import" href="../../bower-assets/paper-card/paper-card.html">
<link rel="import" href="../../bower-assets/paper-input/paper-input.html">
<link rel="import" href="../../bower-assets/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower-assets/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower-assets/paper-item/paper-item.html">
<link rel="import" href="../../bower-assets/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower-assets/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower-assets/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower-assets/iron-list/iron-list.html">
<link rel="import" href="../../bower-assets/iron-icon/iron-icon.html">
<link rel="import" href="../../bower-assets/iron-input/iron-input.html">
<link rel="import" href="../../bower-assets/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower-assets/paper-toggle-button/paper-toggle-button.html">

<!-- Custom AutoComplete -->
<link rel="import" href="../../bower-assets/paper-autocomplete/paper-autocomplete.html">

<link rel="import" href="../../bower-assets/vaadin-combo-box/vaadin-combo-box.html">

<!-- style -->
<link rel="import" href="../../styles/common-style.html">

<!-- behavior -->
<link rel="import" href="../../behaviors/db-using.html">
<link rel="import" href="../../behaviors/translating.html">
<link rel="import" href="../../behaviors/page-like.html">
<link rel="import" href="../../behaviors/api-calling.html">

<dom-module id="page-create-invoice">
  <template>

    <!-- style -->

    <style is="custom-style" include="common-style">
      .limiting-container {
        margin-top: 10px;
      }

      paper-card.no-padding {
        --paper-card-content: {
          padding: 0;
        }
      }

      .card-custom-header {
        padding: 15px;
        border-bottom: 1px solid var(--paper-grey-200);
        background-color: var(--paper-grey-50);
      }

      .card-custom-header .title {
        font-size: 20px;
        font-weight: 500;
        line-height: 28px;
        color: var(--brand-primary-color);
      }

      .item {
        padding: 10px;
      }

      .item:nth-child(even) {
        background-color: var(--paper-grey-100);
      }

      .text-mute {
        color: var(--paper-grey-700);
      }

      .text-warning {
        color: var(--paper-orange-600);
      }

      .choice-list,
      .invoice-list {
        width: 100%;
        margin-top: 10px;
      }

      .choice-list {
        height: 100vh;
        overflow: auto;
      }

      .invoice-list {
        margin-left: 10px;
        height: 100vh;
        overflow: auto;
      }

      .invoice-list .invoice-item {
        padding: 10px 0;
        margin-left: 20px;
        border-bottom: 1px solid #eee;
      }

      .invoice-item :first-child {
        padding-right: 15px;
      }

      .add {
        color: var(--paper-green-500);
      }

      .page-invoice {
        @apply(--layout-horizontal);
        width: 100%;
      }

      .calculation {
        background-color: var(--paper-blue-grey-50);
      }

      .calculation>* {
        padding: 5px 0;
        border-bottom: 1px solid #f5f5f5;
      }

      .calculation>div:last-child {
        border-bottom: 0;
      }

      .calculation paper-input {
        --paper-input-prefix: {
          margin-right: 10px;
          color: #999;
        }
      }

      .text-success {
        color: var(--paper-green-400);
      }

      iron-list {
        height: 400px;
      }

      #invoiceSearchInput {
        padding: 0 15px;
      }

      .big-text-input {
        width: 300px;
        --paper-input-container-input: {
          font-size: 21px;
        }
        --paper-input-prefix: {
          font-size: 21px;
        }
      }

      .table {
        width: 100%;
        border-collapse: collapse;
      }

      .table th {
        text-align: left;
        background-color: var(--paper-grey-50);
      }

      .table td,
      .table th {
        vertical-align: left;
        padding: 15px;
        border-top: 1px solid var(--paper-grey-500);
      }

      .calculation .table th {
        text-align: right;
        background-color: transparent;
      }

      .calculation .table td,
      .calculation .table th {
        vertical-align: left;
        padding: 15px;
        border-top: 1px solid var(--paper-grey-300);
      }

      input:invalid {
        border: 1px solid red;
      }

      .no-rounded-border {
        border-radius: 0;
      }

      .edit-icon {
        display: inline-block;
        margin-left: 4px;
        --paper-icon-button: {
          height: 18px;
          width: 18px;
          padding: 0;
        }
      }

      @media only screen and (max-width: 1024px) {
        .page-invoice {
          @apply(--layout-vertical);
        }

        .choice-list,
        .invoice-list {
          height: 100%;
        }

        .invoice-list {
          margin-left: 0;
        }
      }
    </style>

    <div class="master-container">

      <div class="limiting-container">

        <section class="">

          <paper-card heading="Invoice">

            <div class="card-content">

              <div>
                <strong>Serial: &nbsp;</strong>
                <span class="type label bg-gray">[[invoice.serial]]</span class="type label bg-gray">
              </div>

              <div class="layout horizontal start m-top-8">
                <strong>Created Date: &nbsp;</strong>
                <span> [[$formatDateTime(invoice.createdDatetimeStamp)]]</span>
                <paper-icon-button on-tap="visitDateChangeOpenModalClicked" icon="create" class="edit-icon"></paper-icon-button>
              </div>

              <div class="layout horizontal center">
                <div class="type bold m-right-16">Type: </div>
                <paper-radio-group selected="{{visit.dischargeNote.dischargeType}}" class="layout horizontal">
                  <paper-radio-button name="OPD">OPD</paper-radio-button>
                  <paper-radio-button name="IPD">IPD</paper-radio-button>
                  <paper-radio-button name="Exclusion Criteria">Exclusion Criteria</paper-radio-button>
                </paper-radio-group>
              </div>

            </div>
          </paper-card>

        </section>

        <!--INVOICE SECTION-->
        <section>

          <paper-card class="m-top-8">

            <div class="card-content">
              <vaadin-combo-box class="" label="Search Item to Add" items="[[invoiceAutoCompleteSourceDataList]]" on-value-changed="invoiceItemAutocompleteSelected"></vaadin-combo-box>
            </div>

            <div class="card-actions layout horizontal center justified">
              <paper-toggle-button class="m-right-16" checked="{{showCategories}}">Show Categories</paper-toggle-button>
              <paper-button class="btn btn-sm btn-primary" on-tap="addCustomItemToInvoiceButtonPressed">
                <iron-icon icon="add"></iron-icon>
                Add Custom Item
              </paper-button>
            </div>
          </paper-card>

          <template is="dom-if" if="[[showCategories]]">

            <template is="dom-repeat" items="[[priceListCategories]]" as="categoryName">

              <paper-card class="no-rounded-border no-padding">
                <div class="card-custom-header" on-tap="toggleCollapseClicked">
                  <div class="layout horizontal justified center">
                    <div class="title flex">
                      <iron-icon icon="expand-more"></iron-icon> [[categoryName]]</div>
                  </div>
                </div>
                <div class="card-content">
                  <iron-collapse id="[[convertCategoryNameToId(categoryName)]]">
                    <div class="collapse-content">
                      <iron-list items="[[getDataForCategory(categoryName)]]">
                        <template>
                          <div class="item layout horizontal center">
                            <paper-icon-button class="add" icon="add-circle" on-tap="addToListButtonClicked"></paper-icon-button>
                            <div class="flex">[[item.name]]</div>
                            <div class="type caption m-right-8 secondary">[[item.subCategory]]</div>
                            <div>[[item.price]] BDT</div>
                          </div>
                        </template>
                      </iron-list>
                    </div>
                  </iron-collapse>
                </div>
              </paper-card>

            </template>
          </template>

          <paper-card class="m-top-8 no-padding">

            <div class="card-content">

              <template is="dom-if" if="[[!invoice.data.length]]">
                <div class="layout horizontal center center-justified p-16">Add Item</div>
              </template>

              <template is="dom-if" if="[[invoice.data.length]]">
                <table class="table">
                  <tr>
                    <th width="80">Unit Price</th>
                    <th width="80">Qty</th>
                    <th>Description</th>
                    <th width="80">Gross</th>
                    <th width="80"></th>
                  </tr>
                  <template id="invoice-item-repeater" is="dom-repeat" items="[[invoice.data]]">
                    <tr>
                      <td>
                        <template is="dom-if" if="[[item.price]]">
                          <div class="flex-1">[[item.price]]</div>
                        </template>
                        <template is="dom-if" if="[[!item.price]]">
                          <paper-input class="flex-1" type="number" on-change="itemUnitPriceChanged" no-label-float style="padding-right:10px;"></paper-input>
                        </template>
                      </td>
                      <td>
                        <paper-input class="flex-1" label="Qty" type="number" value="[[item.qty]]" on-input="quantityChanged" no-label-float style="padding-right:10px;"></paper-input>
                      </td>
                      <td>
                        <div class="flex-7 layout vertical">
                          <div>
                            [[item.name]]
                            <template is="dom-if" if="[[item.subCategory]]">
                              <span class="type secondary">[[item.subCategory]]</span>
                            </template>
                          </div>
                          <template is="dom-if" if="[[item.itemList]]">
                            <ul>
                              <template is="dom-repeat" items="[[item.itemList]]" as="packageItem">
                                <li>[[packageItem.name]]</li>
                              </template>
                            </ul>
                          </template>
                        </div>
                      </td>
                      <td>
                        <div class="flex-2">[[$calculateItemTotalPrice(item.price, item.qty)]]
                          <span class="text-mute">BDT</span>
                        </div>
                      </td>
                      <td>
                        <paper-icon-button class="flex-1" icon="delete" on-tap="deleteInvoiceItem"></paper-icon-button>
                      </td>
                    </tr>


                  </template>
                </table>
              </template>

              <div class="layout vertical calculation">

                <table class="table">
                  <tr>
                    <th>Total</th>
                    <td width="190">[[invoice.totalBilled]] BDT</td>
                  </tr>
                  <tr>
                    <th>Paid Amount</th>
                    <td>
                      <input style="font-size: 16px" is="iron-input" type="number" bind-value="{{invoice.paid}}" min="0" max="[[invoice.totalBilled]]"
                        auto-validate prevent-invalid-input required/>
                    </td>
                  </tr>
                  <tr>
                    <th>Due</th>
                    <td>[[_calculateDue(invoice.totalBilled, invoice.paid, invoice.lastPaid)]] BDT</td>
                  </tr>
                  <tr>
                    <th>Total Amount Received:</th>
                    <td>[[_calculateTotalAmtReceived(invoice.paid, invoice.lastPaid)]] BDT</td>
                  </tr>
                </table>

              </div>


            </div>
            <div class="card-actions vertical layout">
              <div>
                <paper-button class="btn btn-primary btn-sm" on-tap="chargeOutdoorWalletButtonPressed">Charge Wallet</paper-button>
              </div>

              <div class="m-top-16">
                <paper-checkbox checked="{{invoice.availableToPatient}}">Send To Patient</paper-checkbox>
                <paper-button raised class="btn btn-success" on-tap="saveAndCompleteInvoiceButtonClicked">Save + Complete Invoice</paper-button>
                <paper-button class="btn btn-success" on-tap="saveInvoiceButtonClicked">Save Invoice</paper-button>
              </div>
            </div>
          </paper-card>
        </section>


      </div>
    </div>

    <!--Modal for Custom Unit and Price-->
    <paper-dialog id="customItemModal" on-iron-overlay-closed="modalClosedEvent" no-cancel-on-esc-key no-cancel-on-outside-click>
      <h2>Add Item</h2>
      <paper-dialog-scrollable>
        <paper-item class="layout vertical">
          <paper-input autofocus label="Item Name" value="{{customUnit.name}}"></paper-input>
          <paper-input label="Actual Cost" type="number" value="{{customUnit.actualCost}}"></paper-input>
          <paper-input label="Unit Price" type="number" value="{{customUnit.price}}"></paper-input>
        </paper-item>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button raised dialog-confirm>Add</paper-button>
      </div>
    </paper-dialog>

    <!-- Dialog for Changing Visit Date start -->
    <paper-dialog id="visitDateModal">
      <h2>Change Invoice Date</h2>
      <div class="p-16">
        <input class="m-left-8" type="date" is="iron-input" required bind-value="{{customVisitDate}}">
        <input class="m-left-8" type="time" is="iron-input" required bind-value="{{customVisitTime}}">
      </div>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button class="btn btn-primary" on-tap="saveNewVisitDateButtonClicked">Save</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script src="../mixin/load-price-list-mixin.coffee-compiled.js "></script>
  <script src="page-create-invoice.coffee-compiled.js"></script>
</dom-module>